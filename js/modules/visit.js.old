/**
 * FILE: js/visit.js
 * CH·ª®C NƒÇNG: Qu·∫£n l√Ω quy tr√¨nh Kh√°m b·ªánh, B·∫£n ƒë·ªì Huy·ªát 3D & Logic thu·ªëc.
 * PHI√äN B·∫¢N: 4.0 (Ultimate: 3D Map + Glowing Meridians + Time Capsules)
 */

// ============================================================
// 1. D·ªÆ LI·ªÜU ƒê·ªí H·ªåA (SVG PATHS)
// ============================================================

// H√¨nh d√°ng c∆° th·ªÉ theo c√°c g√≥c nh√¨n (SVG Path)
const BODY_PATHS = {
    front: "M150,50 C150,50 170,50 170,70 L180,80 L230,80 L240,150 L200,150 L200,250 L220,400 L190,550 L160,550 L160,350 L140,350 L140,550 L110,550 L80,400 L100,250 L100,150 L60,150 L70,80 L120,80 L130,70 C130,70 150,70 150,50 Z",
    back: "M150,50 C150,50 170,50 170,70 L180,85 L230,90 L235,160 L200,160 L200,250 L220,400 L190,550 L160,550 L160,360 L140,360 L140,550 L110,550 L80,400 L100,250 L100,160 L65,160 L70,90 L120,85 L130,70 C130,70 150,70 150,50 Z",
    // H√¨nh d√°ng M·∫∑t
    face: "M100,100 Q150,40 200,100 Q210,150 200,220 Q150,280 100,220 Q90,150 100,100 M120,140 Q130,130 140,140 M160,140 Q170,130 180,140 M150,160 L150,190 M130,210 Q150,230 170,210", 
    // H√¨nh d√°ng Tay
    hand: "M120,300 L110,250 Q100,200 130,180 L140,120 Q150,110 160,120 L165,170 L175,110 Q185,100 195,110 L190,170 L210,120 Q220,110 230,120 L220,180 L240,160 Q250,150 260,160 L240,220 Q200,250 180,300 Z",
    // H√¨nh d√°ng Ch√¢n
    foot: "M120,100 Q180,100 200,200 L200,400 Q210,450 180,450 L120,450 Q90,450 100,400 L100,200 Q100,100 120,100",
    // H√¨nh d√°ng B√™n
    side: "M140,60 Q160,60 160,100 L160,500 L130,500 L130,250 L120,250 L120,100 Q120,60 140,60",
    // H√¨nh d√°ng ƒê·∫ßu
    head: "M100,100 Q150,20 200,100 Q200,180 150,200 Q100,180 100,100"
};

// D·ªØ li·ªáu ƒë∆∞·ªùng ch·∫°y kinh l·∫°c (M·∫´u m√¥ ph·ªèng ƒë·ªÉ test hi·ªáu ·ª©ng Glow)
const MERIDIAN_PATHS = {
    'Ph·∫ø': { color: '#ffca28', view: 'front', path: "M75,18 Q80,25 85,28 T90,40 T93,48" },
    'ƒê·∫°i Tr∆∞·ªùng': { color: '#ff7043', view: 'front', path: "M90,49 L88,44 L83,28 L80,17 L54,8" },
    'V·ªã': { color: '#8d6e63', view: 'front', path: "M56,5 L58,9 L60,65 L62,92" },
    'T·ª≥': { color: '#ffeb3b', view: 'front', path: "M58,94 L56,82 L57,64 L65,38" },
    'B√†ng Quang': { color: '#42a5f5', view: 'back', path: "M54,9 L60,20 L60,38 L58,65 L65,95" },
    'Th·∫≠n': { color: '#7e57c2', view: 'front', path: "M58,95 L56,85 L50,42 L58,18" },
    'Can': { color: '#66bb6a', view: 'front', path: "M64,96 L63,90 L62,30" },
    'ƒê·ªüm': { color: '#26a69a', view: 'side', path: "M140,65 L145,200 L135,450" }
};

// ============================================================
// 2. KH·ªûI T·∫†O BI·∫æN TR·∫†NG TH√ÅI
// ============================================================
window.currentVisit = { 
    step: 1, 
    rxEast: [], rxWest: [], procs: [], acupoints: [], 
    manualMedTotalEast: 0, manualMedTotalWest: 0,
    eastDays: 1, westDays: 1,
    eastNote: "", westNote: "",
    manualPriceEast: 0, manualPriceWest: 0,
    tuChan: {vong:[],van:[],vanhoi:[],thiet:[],thietchan:[],machchan:[]} 
};

// Bi·∫øn to√†n c·ª•c cho AI v√† B·∫£n ƒë·ªì
let currentAiSuggestions = { points: [], herbs: [], messages: [], syndromeFound: null };
let currentAcupointFilter = { type: 'region', value: 'all' }; 
let currentHerbFilter = 'all'; 
let currentBodyView = 'front'; // M·∫∑c ƒë·ªãnh nh√¨n m·∫∑t tr∆∞·ªõc

window.visitModuleReady = true;

// ============================================================
// 3. C·∫§U H√åNH INPUT NH·∫¨P LI·ªÜU (NATIVE)
// ============================================================
window.setupNativeInputs = function() {
    const configs = [
        { id: 'vBpSys', handler: window.updateBpDisplay },
        { id: 'vBpDia', handler: window.updateBpDisplay },
        { id: 'vPulse', handler: null },
        { id: 'vHeight', handler: window.updateHeightWeightDisplay },
        { id: 'vWeight', handler: window.updateHeightWeightDisplay },
        { id: 'vEastDays', handler: window.calcTotal },
        { id: 'vWestDays', handler: window.calcTotal },
        { id: 'vEastManualPrice', handler: window.calcTotal },
        { id: 'vWestManualPrice', handler: window.calcTotal },
        { id: 'vCost', handler: window.calcTotal },
        { id: 'vDiscountPercent', handler: () => {
            const val = document.getElementById('vDiscountPercent').value;
            const btn = document.getElementById('discountBtn');
            if(btn) btn.innerText = val + "% ‚ñº";
            window.calcTotal();
        }},
        { id: 'pYear', handler: null },
        { id: 'pPhone', handler: null, type: 'tel' }
    ];

    configs.forEach(cfg => {
        const el = document.getElementById(cfg.id);
        if (el) {
            el.type = cfg.type || 'number'; 
            if(el.type === 'number') { el.inputMode = 'decimal'; el.pattern = '[0-9]*'; } 
            else if (el.type === 'tel') { el.inputMode = 'numeric'; el.pattern = '[0-9]*'; }
            el.removeAttribute('readonly'); el.onclick = null;
            if(cfg.handler) el.oninput = cfg.handler;
            el.onfocus = function() { this.select(); };
            el.style.pointerEvents = 'auto'; el.style.backgroundColor = '#fff';
        }
    });
};

// ============================================================
// 4. B·∫ÆT ƒê·∫¶U KH√ÅM (START VISIT)
// ============================================================
window.startVisit = function(pid, vid=null) {
    const p = window.db.find(x => x.id == pid); if(!p) return;
    document.getElementById('vPid').value = pid; 
    document.getElementById('vVisitId').value = vid || '';
    document.getElementById('vPatientName').innerText = p.name;
    
    // Reset Data
    window.currentVisit = { 
        step: 1, rxEast: [], rxWest: [], procs: [], acupoints: [],
        manualMedTotalEast: 0, manualMedTotalWest: 0, eastDays: 1, westDays: 1,
        eastNote: "", westNote: "", manualPriceEast: 0, manualPriceWest: 0,
        tuChan: {vong:[],van:[],vanhoi:[],thiet:[],thietchan:[],machchan:[]} 
    };
    currentAiSuggestions = { points: [], herbs: [], messages: [], syndromeFound: null };
    
    // Reset UI Elements
    document.getElementById('vDate').value = window.getLocalDate();
    document.getElementById('vDiseaseInput').value = ''; 
    document.getElementById('vSpecial').value = '';
    document.getElementById('vCost').value = 0; 
    document.getElementById('vDiscountPercent').value = 0;
    document.getElementById('vEastDays').value = 1;
    document.getElementById('vWestDays').value = 1;
    document.getElementById('vEastManualPrice').value = ""; 
    document.getElementById('vWestManualPrice').value = ""; 
    document.getElementById('vEastNote').value = "";
    document.getElementById('vWestNote').value = "";
    
    document.getElementById('displayMedTotalEast').innerText = '0ƒë';
    document.getElementById('displayMedTotalWest').innerText = '0ƒë';
    document.getElementById('displayProcTotal').innerText = '0ƒë';
    document.getElementById('displayGrandTotal').innerText = '0ƒë';
    document.getElementById('finalTotal').innerText = '0ƒë';
    
    const aiBox = document.getElementById('aiSuggestionBox');
    if(aiBox) aiBox.classList.add('hidden');
    const acuList = document.getElementById('vAcupointList');
    if(acuList) acuList.innerHTML = '';
    
    // Load Danh s√°ch b·ªánh m·∫´u
    if(window.config.diseases) {
        document.getElementById('vDiseaseSelect').innerHTML = '<option value="">-- Ch·ªçn b·ªánh m·∫´u --</option>' + window.config.diseases.map(d=>`<option value="${d.name}">${d.name}</option>`).join('');
    }
    
    window.initDefaultValues();

    // N·∫øu s·ª≠a ƒë∆°n c≈© -> Load d·ªØ li·ªáu
    if(vid) {
        const v = p.visits.find(x => x.id == vid);
        if(v) {
            document.getElementById('vDate').value = v.date; 
            document.getElementById('vDiseaseInput').value = v.disease;
            document.getElementById('vSpecial').value = v.symptoms; 
            document.getElementById('vCost').value = v.cost;
            document.getElementById('vDiscountPercent').value = v.disc || 0; 
            document.getElementById('vPaid').checked = v.paid;
            
            if(v.tuChan) window.currentVisit.tuChan = v.tuChan;
            if(v.vong) document.getElementById('vVongExtra').value = v.vong;
            
            ['eastDays','westDays','manualPriceEast','manualPriceWest'].forEach(k => { if(v[k] !== undefined) window.currentVisit[k] = v[k]; });
            window.currentVisit.eastNote = v.eastNote || ""; window.currentVisit.westNote = v.westNote || "";
            
            document.getElementById('vEastDays').value = window.currentVisit.eastDays;
            document.getElementById('vWestDays').value = window.currentVisit.westDays;
            document.getElementById('vEastNote').value = window.currentVisit.eastNote;
            document.getElementById('vWestNote').value = window.currentVisit.westNote;
            document.getElementById('vEastManualPrice').value = window.currentVisit.manualPriceEast || "";
            document.getElementById('vWestManualPrice').value = window.currentVisit.manualPriceWest || "";

            window.currentVisit.rxEast = JSON.parse(JSON.stringify(v.rxEast||[])); 
            window.currentVisit.rxWest = JSON.parse(JSON.stringify(v.rxWest||[]));
            window.currentVisit.procs = JSON.parse(JSON.stringify(v.procs||[]));
            window.currentVisit.acupoints = JSON.parse(JSON.stringify(v.acupoints||[]));
        }
    } else {
        document.getElementById('vPaid').checked = true;
    }
    
    // Render t·∫•t c·∫£ danh s√°ch
    window.renderMedList('east'); window.renderMedList('west'); window.renderProcOptions();
    window.renderProcList(); window.renderSelectedAcupoints(); window.calcTotal(); 
    window.setupNativeInputs();
    
    // [QUAN TR·ªåNG] ƒê·ªìng b·ªô n√∫t S√°ng/Tr∆∞a/Chi·ªÅu/T·ªëi n·∫øu c√≥ d·ªØ li·ªáu c≈©
    if(window.updateGlobalButtonsFromText) window.updateGlobalButtonsFromText();

    window.goToStep(1); 
    document.getElementById('vModal').classList.add('active');
};

// --- UI HELPERS ---
window.initDefaultValues = function() {
    const sys = document.getElementById('vBpSys');
    if(sys && !sys.value) {
        document.getElementById('vBpSys').value=120; document.getElementById('vBpDia').value=80;
        document.getElementById('vPulse').value=80; document.getElementById('vHeight').value=165; document.getElementById('vWeight').value=60;
    }
    window.updateBpDisplay(); window.updateHeightWeightDisplay();
};
window.updateBpDisplay = function() { document.getElementById('displayBP').innerText = (document.getElementById('vBpSys').value||120)+'/'+(document.getElementById('vBpDia').value||80); };
window.updateHeightWeightDisplay = function() {
    const h = document.getElementById('vHeight').value, w = document.getElementById('vWeight').value;
    document.getElementById('displayHeightWeight').innerText = `${h}cm - ${w}kg`;
    if(h>0 && w>0) document.getElementById('displayBMI').innerText = 'BMI: ' + (w/((h/100)*(h/100))).toFixed(1);
};

// ============================================================
// 5. NAVIGATION (CHUY·ªÇN TAB)
// ============================================================
window.goToStep = function(s) {
    window.currentVisit.step = s;
    document.querySelectorAll('.step-content').forEach(e => { e.classList.remove('active'); e.classList.add('hidden'); });
    document.getElementById('step'+s).classList.remove('hidden'); 
    document.getElementById('step'+s).classList.add('active');
    
    document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', i+1===s));
    document.getElementById('btnBack').classList.toggle('hidden', s===1);
    document.getElementById('btnNext').classList.toggle('hidden', s===4);
    document.getElementById('btnSaveOnly').classList.toggle('hidden', s!==4);
    document.getElementById('btnPrint').classList.toggle('hidden', s!==4);
    
    if(s===1) window.renderTuchanChips();
    if(s===3||s===4) window.calcTotal();
    
    if(s===3) {
        window.injectCustomButtons(); 
        try { if(window.refreshAiSuggestion) window.refreshAiSuggestion(false); } catch(e){}
        // [FIX] C·∫≠p nh·∫≠t l·∫°i m√†u s·∫Øc n√∫t Time Capsules khi chuy·ªÉn sang tab 3
        if(window.updateGlobalButtonsFromText) window.updateGlobalButtonsFromText();
    }
    if(s===4 && window.config.qrCodeImage) {
        document.getElementById('qrPaymentSection').classList.remove('hidden'); 
        document.getElementById('displayQrPayment').src = window.config.qrCodeImage; 
    }
};
window.nextStep = function() { if(window.currentVisit.step<4) window.goToStep(window.currentVisit.step+1); };
window.prevStep = function() { if(window.currentVisit.step>1) window.goToStep(window.currentVisit.step-1); };

// ============================================================
// 6. T·ª® CH·∫®N & AI
// ============================================================
window.renderTuchanChips = function() {
    ['vong','van','vanhoi','thiet','thietchan','machchan'].forEach(sec => {
        const c = document.getElementById(`tuchan${sec.charAt(0).toUpperCase()+sec.slice(1)}Buttons`);
        if(c && window.config.tuChan[sec]) {
             c.innerHTML = window.config.tuChan[sec].map(t=>`
            <div class="tuchan-chip ${window.currentVisit.tuChan[sec].includes(t)?'active':''}" 
                 onclick="window.toggleTuchanChip('${sec}','${t.replace(/'/g,"\\'")}')">${t}</div>`).join('');
        }
    });
};

window.toggleTuchanChip = function(sec,t) {
    const idx = window.currentVisit.tuChan[sec].indexOf(t);
    if(idx===-1) window.currentVisit.tuChan[sec].push(t); 
    else window.currentVisit.tuChan[sec].splice(idx,1);
    window.renderTuchanChips();
    try { if(window.refreshAiSuggestion) window.refreshAiSuggestion(false); } catch(e){}
};

window.loadDiseaseSuggestions = function() {
    const dName = document.getElementById('vDiseaseSelect').value;
    const box = document.getElementById('suggestedSymptomsBox');
    const preArea = document.getElementById('eastPresetsArea');
    if(!dName) { box.classList.add('hidden'); preArea.classList.add('hidden'); return; }
    const d = window.config.diseases.find(x => x.name === dName);
    if(d) {
        if(d.sym) { 
            box.classList.remove('hidden'); 
            const syms = d.sym.split(',').map(s => s.trim()).filter(s => s);
            document.getElementById('symptomButtons').innerHTML = syms.map(s=>`<span onclick="window.addSymptom('${s}')" class="med-chip">+ ${s}</span>`).join(''); 
        } else box.classList.add('hidden');
        window.currentVisit.rxWest = JSON.parse(JSON.stringify(d.rxWest||[])); 
        window.renderMedList('west');
        if(d.eastOptions?.length) { 
            preArea.classList.remove('hidden'); 
            document.getElementById('eastPresetButtons').innerHTML = d.eastOptions.map((o,i)=>`
                <div class="med-chip ${i===0?'active-preset':''}" onclick="window.applyEasternSample(${i})">${o.name}</div>`).join(''); 
            if(d.eastOptions.length > 0) window.applyEasternSample(0);
        } else preArea.classList.add('hidden');
        window.calcTotal();
    }
};

window.addSymptom = function(text) {
    const el = document.getElementById('vSpecial');
    if (!el.value.includes(text)) {
        el.value = el.value ? el.value + ", " + text : text;
        try { if(window.refreshAiSuggestion) window.refreshAiSuggestion(false); } catch(e){}
    }
};

window.applyEasternSample = function(i) {
    const btns = document.querySelectorAll('#eastPresetButtons .med-chip');
    btns.forEach((btn, idx) => idx === i ? btn.classList.add('active-preset') : btn.classList.remove('active-preset'));
    const d = window.config.diseases.find(x => x.name === document.getElementById('vDiseaseSelect').value);
    if(d && d.eastOptions[i]) { 
        window.currentVisit.rxEast = JSON.parse(JSON.stringify(d.eastOptions[i].ingredients)); 
        window.renderMedList('east'); 
        window.calcTotal(); 
    }
};

// ============================================================
// 7. B·∫¢N ƒê·ªí HUY·ªÜT 3D (VISUAL MAP) & AI G·ª¢I √ù
// ============================================================

window.openAcupointModal = function() {
    console.log("ƒêang m·ªü tra c·ª©u huy·ªát...");
    
    // 1. Ki·ªÉm tra v√† t·∫£i Template n·∫øu ch∆∞a c√≥
    let modal = document.getElementById('acupointModal');
    if (!modal) {
        if(window.loadAllModals) {
            window.loadAllModals();
            modal = document.getElementById('acupointModal');
        }
        if(!modal) {
            alert("L·ªói: Kh√¥ng t·∫£i ƒë∆∞·ª£c giao di·ªán tra c·ª©u. Vui l√≤ng t·∫£i l·∫°i trang.");
            return;
        }
    }

    // 2. √âp hi·ªÉn th·ªã l√™n tr√™n c√πng (Z-Index)
    modal.style.zIndex = "3000"; 
    modal.classList.add('active');

    // 3. Setup UI
    try { window.renderAcupointSidebar(); } catch(e) {}
    try { window.filterAcupointGrid('region', 'all'); } catch(e) {}
    
    // 4. M·∫∑c ƒë·ªãnh v·∫Ω view 'front'
    window.switchBodyView('front'); 
    
    // 5. Ch·∫°y AI v√† hi·ªÉn th·ªã gi·ªù T√≠ Ng·ªç
    try { 
        if(window.refreshAiSuggestion) window.refreshAiSuggestion(true); 
        
        if (window.knowledge && window.knowledge.ziWuFlow) {
            const timeInfo = window.knowledge.ziWuFlow.getCurrentFlow();
            const subLabel = document.getElementById('acuTimeSuggestion');
            if(subLabel && timeInfo) subLabel.innerText = `Gi·ªù ${timeInfo.can} ${timeInfo.chi}: Huy·ªát Khai ${timeInfo.openPoint}`;
        }
    } catch(e) {}
};

window.switchBodyView = function(view) {
    currentBodyView = view;
    // C·∫≠p nh·∫≠t tab active
    document.querySelectorAll('.view-tab-btn').forEach(b => b.classList.remove('active'));
    const activeBtn = document.getElementById('tab_' + view);
    if(activeBtn) activeBtn.classList.add('active');
    
    window.renderBodyMap(view);
};

window.renderBodyMap = function(view) {
    const silhouette = document.getElementById('bodySilhouette');
    const pointsLayer = document.getElementById('mapPointsLayer');
    const meridianLayer = document.getElementById('meridianLayer');
    const label = document.getElementById('activeMeridianLabel');
    
    if (!silhouette || !pointsLayer) return;

    // 1. V·∫Ω H√¨nh Ng∆∞·ªùi (Silhouette)
    const pathD = BODY_PATHS[view] || BODY_PATHS['front'];
    silhouette.innerHTML = `<path d="${pathD}" />`;

    // 2. V·∫Ω ƒê∆∞·ªùng Kinh (Glow Effect)
    meridianLayer.innerHTML = '';
    if(label) label.classList.add('hidden');
    
    if (currentAcupointFilter.type === 'meridian' && currentAcupointFilter.value !== 'all') {
        const mName = currentAcupointFilter.value; 
        const mData = MERIDIAN_PATHS[mName];
        
        // Ch·ªâ v·∫Ω n·∫øu kinh l·∫°c n√†y c√≥ ƒë∆∞·ªùng ƒëi ·ªü view hi·ªán t·∫°i
        if (mData && mData.view === view) {
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", mData.path);
            path.setAttribute("stroke", mData.color || '#ffca28');
            path.setAttribute("class", "meridian-path");
            meridianLayer.appendChild(path);
            
            if(label) {
                label.innerText = `ƒê∆Ø·ªúNG KINH: ${mName}`;
                label.classList.remove('hidden');
            }
        }
    }

    // 3. V·∫Ω ƒêi·ªÉm Huy·ªát
    pointsLayer.innerHTML = '';
    // L·ªçc huy·ªát theo view hi·ªán t·∫°i
    const pointsToDraw = window.knowledge.acupoints.filter(p => p.pos && p.pos.view === view);

    pointsToDraw.forEach(p => {
        // Chuy·ªÉn t·ªça ƒë·ªô % th√†nh SVG 300x600
        const cx = (p.pos.x / 100) * 300; 
        const cy = (p.pos.y / 100) * 600;

        const isSelected = window.currentVisit.acupoints.some(x => x.id === p.id);
        const isSuggested = currentAiSuggestions.points.includes(p.id);

        // Logic l√†m m·ªù huy·ªát kh√¥ng li√™n quan
        let isDimmed = false;
        if (currentAcupointFilter.value !== 'all') {
            if (currentAcupointFilter.type === 'meridian' && p.meridian !== currentAcupointFilter.value) isDimmed = true;
            if (currentAcupointFilter.type === 'region' && p.region !== currentAcupointFilter.value) isDimmed = true;
        }

        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", cx);
        circle.setAttribute("cy", cy);
        
        let r = 4;
        let className = "map-point";
        
        if (isDimmed) {
            className += " dimmed"; r = 2;
        } else {
            if (isSelected) className += " active";
            if (isSuggested && !isSelected) className += " suggested";
            if (isSelected) r = 6;
        }

        circle.setAttribute("r", r);
        circle.setAttribute("class", className);
        
        if (!isDimmed) {
            circle.onclick = (e) => { e.stopPropagation(); window.toggleAcupoint(p.id, p.name); };
            circle.onmouseenter = (e) => {
                const tt = document.getElementById('mapTooltip');
                tt.innerHTML = `<b>${p.name}</b> (${p.id})<br><span class="text-gray-300">${p.region}</span>`;
                const rect = document.getElementById('bodyMapContainer').getBoundingClientRect();
                tt.style.left = (e.clientX - rect.left) + 'px';
                tt.style.top = (e.clientY - rect.top) + 'px';
                tt.classList.remove('hidden');
            };
            circle.onmouseleave = () => document.getElementById('mapTooltip').classList.add('hidden');
        }

        pointsLayer.appendChild(circle);
    });
};

window.renderAcupointSidebar = function() {
    const sb = document.getElementById('acuSidebar');
    if(!sb || !window.knowledge) return;

    let html = `<button onclick="window.filterAcupointGrid('region','all')" class="w-full text-left px-3 py-2 rounded text-sm font-bold hover:bg-gray-100 mb-1 ${currentAcupointFilter.value === 'all' ? 'bg-[#efebe9] text-[#3e2723]' : 'text-gray-600'}">T·∫•t c·∫£</button>`;
    html += `<div class="text-[10px] font-bold text-gray-400 uppercase mt-3 mb-1 px-2">V√πng C∆° Th·ªÉ</div>`;
    window.knowledge.regions.forEach(r => {
        html += `<button onclick="window.filterAcupointGrid('region','${r}')" class="w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-100 ${currentAcupointFilter.type==='region' && currentAcupointFilter.value===r ? 'bg-[#efebe9] font-bold text-[#5d4037]' : 'text-gray-600'}">${r}</button>`;
    });
    html += `<div class="text-[10px] font-bold text-gray-400 uppercase mt-3 mb-1 px-2">ƒê∆∞·ªùng Kinh</div>`;
    window.knowledge.meridians.forEach(m => {
        html += `<button onclick="window.filterAcupointGrid('meridian','${m}')" class="w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-100 ${currentAcupointFilter.type==='meridian' && currentAcupointFilter.value===m ? 'bg-[#efebe9] font-bold text-[#5d4037]' : 'text-gray-600'}">${m}</button>`;
    });
    sb.innerHTML = html;
};

window.filterAcupointGrid = function(type, val) {
    currentAcupointFilter = { type: type, value: val };
    window.renderAcupointSidebar(); 
    window.renderAcupointGrid();
    window.renderBodyMap(currentBodyView); // C·∫≠p nh·∫≠t c·∫£ b·∫£n ƒë·ªì khi l·ªçc
};

window.renderAcupointGrid = function() {
    const container = document.getElementById('acuContent');
    if(!container || !window.knowledge) return;
    
    // Ti√™u ƒë·ªÅ sidebar (n·∫øu c√≥ th·∫ª id acuCurrentCategory) - Optional
    
    const searchKw = (document.getElementById('acuSearchInput') ? document.getElementById('acuSearchInput').value : '').toLowerCase();
    
    let points = window.knowledge.acupoints.filter(p => {
        if (searchKw && !p.name.toLowerCase().includes(searchKw) && !p.id.toLowerCase().includes(searchKw)) return false;
        if (!searchKw) {
            if (currentAcupointFilter.value === 'all') return true;
            if (currentAcupointFilter.type === 'region') return p.region === currentAcupointFilter.value;
            if (currentAcupointFilter.type === 'meridian') return p.meridian === currentAcupointFilter.value;
        }
        return true;
    });

    container.innerHTML = points.map(p => {
        const isSelected = window.currentVisit.acupoints.some(x => x.id === p.id);
        const isSuggested = currentAiSuggestions.points.includes(p.id);
        
        return `
        <button onclick="window.toggleAcupoint('${p.id}', '${p.name}')" 
            class="w-full flex items-center justify-between p-3 rounded-lg border mb-1 transition-all
            ${isSelected ? 'bg-[#5d4037] text-white border-[#3e2723]' : 'bg-white text-gray-700 border-[#eee] hover:bg-gray-50'}
            ${isSuggested && !isSelected ? 'border-yellow-400 bg-yellow-50' : ''}">
            <div class="flex flex-col text-left">
                <span class="font-bold text-sm flex items-center gap-1">
                    ${p.name} 
                    ${isSuggested ? '<span class="text-[10px] text-yellow-600 bg-yellow-100 px-1 rounded border border-yellow-200">G·ª£i √Ω</span>' : ''}
                </span>
                <span class="text-[10px] opacity-70">${p.id} ‚Ä¢ ${p.region}</span>
            </div>
            ${isSelected ? '<span class="text-white">‚úì</span>' : ''}
        </button>`;
    }).join('');
};

window.toggleAcupoint = function(id, name) {
    const idx = window.currentVisit.acupoints.findIndex(x => x.id === id);
    if(idx > -1) window.currentVisit.acupoints.splice(idx, 1);
    else window.currentVisit.acupoints.push({ id: id, name: name });
    
    window.renderAcupointGrid();
    window.renderSelectedAcupoints();
    if(window.renderBodyMap) window.renderBodyMap(currentBodyView); 
};

window.renderSelectedAcupoints = function() {
    const list = document.getElementById('vAcupointList');
    if(list) {
        list.innerHTML = window.currentVisit.acupoints.map(p => `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-teal-50 text-teal-700 border border-teal-100">
                ${p.name}
                <button onclick="window.toggleAcupoint('${p.id}', '${p.name}')" class="ml-2 text-teal-400 hover:text-red-500 font-black">&times;</button>
            </span>`).join('');
    }
};

// --- QU·∫¢N L√ù MODAL THU·ªêC ---
window.openHerbModal = function() { 
    const m = document.getElementById('herbModal');
    if(m) {
        window.renderHerbSidebar(); 
        window.filterHerbGrid('all'); 
        try { if(window.refreshAiSuggestion) window.refreshAiSuggestion(true); } catch(e){}
        m.style.zIndex = "3000";
        m.classList.add('active'); 
    }
};

window.filterHerbs = function() { window.renderHerbGrid(); };

window.renderHerbSidebar = function() {
    const sb = document.getElementById('herbSidebar'); if(!sb || !window.knowledge) return;
    let html = `<button onclick="window.filterHerbGrid('all')" class="w-full text-left px-3 py-2 rounded text-sm font-bold hover:bg-gray-100 mb-1 ${currentHerbFilter === 'all' ? 'bg-[#efebe9] text-[#3e2723]' : 'text-gray-600'}">T·∫•t c·∫£</button>`;
    html += `<div class="text-[10px] font-bold text-gray-400 uppercase mt-3 mb-1 px-2">Nh√≥m Thu·ªëc</div>`;
    if(window.knowledge.herbCategories) { 
        window.knowledge.herbCategories.forEach(c => { 
            html += `<button onclick="window.filterHerbGrid('${c}')" class="w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-100 ${currentHerbFilter===c ? 'bg-[#efebe9] font-bold text-[#5d4037]' : 'text-gray-600'}">${c}</button>`; 
        }); 
    }
    sb.innerHTML = html;
};

window.filterHerbGrid = function(val) { 
    currentHerbFilter = val; 
    window.renderHerbSidebar(); 
    window.renderHerbGrid(); 
};

window.renderHerbGrid = function() {
    const container = document.getElementById('herbContent'); 
    const title = document.getElementById('herbCurrentCategory'); 
    if(!container || !window.knowledge || !window.knowledge.herbsDB) return;
    
    title.innerText = currentHerbFilter === 'all' ? 'T·∫•t c·∫£ v·ªã thu·ªëc' : currentHerbFilter;
    const searchKw = (document.getElementById('herbSearchInput') ? document.getElementById('herbSearchInput').value : '').toLowerCase();
    
    let herbs = window.knowledge.herbsDB.filter(h => {
        if (searchKw && !h.name.toLowerCase().includes(searchKw)) return false;
        if (!searchKw && currentHerbFilter !== 'all' && h.category !== currentHerbFilter) return false;
        return true;
    });
    
    container.innerHTML = herbs.map(h => {
        const isSuggested = currentAiSuggestions.herbs.includes(h.name);
        return `
        <button onclick="window.addSuggestedMed('east', '${h.name}'); alert('ƒê√£ th√™m ${h.name} v√†o ƒë∆°n!');" 
            class="relative flex flex-col items-center justify-center p-3 rounded-xl border transition-all duration-300 bg-white text-gray-700 border-[#eee] hover:border-[#d7ccc8] hover:shadow-sm 
            ${isSuggested ? 'highlight-suggestion' : ''}">
            ${isSuggested ? '<span class="absolute -top-1 -right-1 flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span></span>' : ''}
            <span class="font-bold text-sm">${h.name}</span>
            <span class="text-[10px] opacity-70 mt-1">${h.category}</span>
        </button>`;
    }).join('');
};

// --- AI REFRESH & G·ª¢I √ù ---
window.refreshAiSuggestion = function(showHighlightOnly = false) {
    if (!window.knowledge || !window.knowledge.analyze) return;

    const symptoms = document.getElementById('vSpecial') ? document.getElementById('vSpecial').value : "";
    const tuChanData = window.currentVisit.tuChan;

    const result = window.knowledge.analyze(symptoms, tuChanData);
    
    if (result) {
        currentAiSuggestions = result;
        const aiBox = document.getElementById('aiSuggestionBox');
        const aiText = document.getElementById('aiSuggestionText');
        if (aiBox && aiText) {
            let htmlContent = "";
            if (result.syndromeFound) htmlContent += `<div class="font-bold text-red-600 mb-1 border-b border-red-200 pb-1 flex items-center gap-2"><span>üîç</span> ${result.syndromeFound}</div>`;
            if (result.messages.length > 0) htmlContent += result.messages.map(m => `<div>${m}</div>`).join('');
            if (htmlContent) { aiBox.classList.remove('hidden'); aiText.innerHTML = htmlContent; } 
            else aiBox.classList.add('hidden');
        }
        if (document.getElementById('acupointModal') && document.getElementById('acupointModal').classList.contains('active')) {
            window.renderAcupointGrid();
            window.renderBodyMap(currentBodyView);
        }
        if (document.getElementById('herbModal') && document.getElementById('herbModal').classList.contains('active')) {
            window.renderHerbGrid();
        }
    }
};

// --- 8. MED LIST & TIME CAPSULE BUTTONS (N√öT TH·ªúI GIAN) ---

// A. LOGIC N√öT TH·ªúI GIAN CHUNG (GHI CH√ö)
window.toggleGlobalEastUsage = function(timeStr) { 
    const el = document.getElementById('vEastNote'); 
    let currentText = el.value || '';
    let parts = currentText.split(',').map(s => s.trim()).filter(s => s); 
    const keywords = ['S√°ng','Tr∆∞a','Chi·ªÅu','T·ªëi']; 
    
    let timeParts = parts.filter(x => keywords.includes(x)); 
    let otherParts = parts.filter(x => !keywords.includes(x)); 
    
    if (timeParts.includes(timeStr)) timeParts = timeParts.filter(t => t !== timeStr); 
    else timeParts.push(timeStr); 
    
    timeParts.sort((a,b) => keywords.indexOf(a) - keywords.indexOf(b)); 
    el.value = [...otherParts, ...timeParts].join(', '); 
    
    window.syncGlobalTimeButtons(timeParts);
};

window.syncGlobalTimeButtons = function(activeTimes) {
    const container = document.getElementById('globalEastTimeGroup');
    if(!container) return;
    Array.from(container.children).forEach(btn => {
        const btnText = btn.innerText.trim();
        if(activeTimes.includes(btnText)) btn.classList.add('active'); 
        else btn.classList.remove('active');
    });
};

window.updateGlobalButtonsFromText = function() {
    const el = document.getElementById('vEastNote');
    if(!el) return;
    const text = el.value || '';
    const keywords = ['S√°ng','Tr∆∞a','Chi·ªÅu','T·ªëi'];
    const activeTimes = keywords.filter(k => text.includes(k));
    window.syncGlobalTimeButtons(activeTimes);
};

// B. LOGIC MED LIST
window.renderMedList = function(type) {
    const list = document.getElementById(type==='east'?'vMedListEast':'vMedListWest');
    const data = type==='east' ? window.currentVisit.rxEast : window.currentVisit.rxWest;
    const days = type==='east' ? window.currentVisit.eastDays : window.currentVisit.westDays;
    
    if (data.length === 0) {
        list.innerHTML = `<div class="text-center py-6 text-gray-400 italic text-sm border-2 border-dashed border-gray-200 rounded-lg bg-gray-50">Ch∆∞a k√™ v·ªã thu·ªëc n√†o</div>`;
        return;
    }

    list.innerHTML = data.map((m,i)=>`
        <div class="proc-card">
            <button onclick="window.removeMed('${type}',${i})" class="proc-del-btn">&times;</button>
            <div class="flex justify-between items-end mb-3 border-b border-dashed border-gray-200 pb-2">
                <input type="text" value="${m.name}" onchange="window.updateMed('${type}',${i},'name',this.value)" class="font-bold text-[#3e2723] text-lg bg-transparent border-none outline-none w-full placeholder-gray-400" placeholder="T√™n thu·ªëc..." onfocus="this.blur=null">
            </div>
            <div class="grid grid-cols-3 gap-3 mb-3">
                <div class="proc-input-group"><label>SL (${type==='east'?'g':'v'})</label><input type="number" value="${m.qty}" oninput="window.updateMed('${type}',${i},'qty',this.value)" onfocus="this.select()" class="proc-input text-center font-bold"></div>
                <div class="proc-input-group"><label>ƒê∆°n gi√°</label><input type="number" value="${m.price||0}" oninput="window.updateMed('${type}',${i},'price',this.value)" onfocus="this.select()" class="proc-input text-center text-right pr-2 font-mono"></div>
                <div class="proc-input-group"><label>Th√†nh ti·ªÅn</label><div class="proc-total-display flex items-center justify-center font-bold text-[#3e2723] bg-gray-100 rounded-lg h-[40px]">${((m.qty||0)*(m.price||0)*days).toLocaleString()}</div></div>
            </div>
            <div class="med-usage-row">
                ${['S√°ng','Tr∆∞a','Chi·ªÅu','T·ªëi'].map(t => `<button class="time-btn-large ${(m.usage||'').includes(t)?'active':''}" onclick="window.toggleMedUsage('${type}',${i},'${t}')">${t}</button>`).join('')}
            </div>
        </div>
    `).join('');
};

window.addMedRow = function(type) { 
    (type==='east' ? window.currentVisit.rxEast : window.currentVisit.rxWest).push({ name:"", qty:10, days:1, price:0, usage:"" }); 
    window.renderMedList(type); 
    window.calcTotal(); 
};

window.addSuggestedMed = function(type, name) {
    const list = type === 'east' ? window.currentVisit.rxEast : window.currentVisit.rxWest;
    const exists = list.some(m => m.name.toLowerCase() === name.toLowerCase());
    if (exists) { return; }
    list.push({ name: name, qty: 10, days: 1, price: 0, usage: "" });
    window.renderMedList(type); 
    window.calcTotal();
    const container = document.getElementById(type === 'east' ? 'vMedListEast' : 'vMedListWest'); 
    setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
};

window.updateMed = function(type,i,f,v) { 
    const meds = type==='east' ? window.currentVisit.rxEast : window.currentVisit.rxWest; 
    meds[i][f] = (f==='qty'||f==='price') ? parseFloat(v) : v; 
    window.calcTotal(); 
    const container = document.getElementById(type==='east'?'vMedListEast':'vMedListWest'); 
    if(container && container.children[i]) { 
        const totalDiv = container.children[i].querySelector('.proc-total-display'); 
        const days = type==='east' ? window.currentVisit.eastDays : window.currentVisit.westDays; 
        if(totalDiv) totalDiv.innerText = ((meds[i].qty||0)*(meds[i].price||0)*days).toLocaleString(); 
    } 
};

window.toggleMedUsage = function(type,i,time) { 
    const med = (type==='east' ? window.currentVisit.rxEast : window.currentVisit.rxWest)[i]; 
    let parts = (med.usage || '').split(',').map(p => p.trim()).filter(p => p); 
    const keywords = ['S√°ng', 'Tr∆∞a', 'Chi·ªÅu', 'T·ªëi']; 
    let tParts = parts.filter(p => keywords.includes(p)); 
    let oParts = parts.filter(p => !keywords.includes(p)); 
    if (tParts.includes(time)) tParts = tParts.filter(t => t !== time); 
    else tParts.push(time); 
    tParts.sort((a, b) => keywords.indexOf(a) - keywords.indexOf(b)); 
    med.usage = [...tParts, ...oParts].join(', '); 
    window.renderMedList(type); 
};

window.removeMed = function(type,i) { 
    (type==='east' ? window.currentVisit.rxEast : window.currentVisit.rxWest).splice(i,1); 
    window.renderMedList(type); 
    window.calcTotal(); 
};

// --- 9. TH·ª¶ THU·∫¨T (PROCEDURES) ---
window.renderProcOptions = function() { 
    const area = document.getElementById('vProcOptionsArea'); 
    if (!window.config.procs || !window.config.procs.length) { 
        area.innerHTML = '<span class="text-xs text-gray-400 italic w-full text-center">Ch∆∞a c√≥ d·ªãch v·ª•.</span>'; 
        return; 
    } 
    area.innerHTML = window.config.procs.map((p, i) => 
        `<button onclick="window.addProcToVisit(${i})" class="bg-white border border-[#d7ccc8] text-[#5d4037] px-3 py-2 rounded-lg text-xs font-bold shadow-sm active:scale-95 transition-transform hover:bg-[#efebe9]">
            ${p.name} <span class="text-[10px] opacity-70 ml-1">(${p.price.toLocaleString()})</span>
        </button>`
    ).join(''); 
};

window.addProcToVisit = function(index) { 
    const p = window.config.procs[index]; 
    window.currentVisit.procs.push({ name: p.name, price: p.price, days: 1, discount: 0, note: '' }); 
    window.renderProcList(); 
    window.calcTotal(); 
};

window.renderProcList = function() { 
    const container = document.getElementById('vProcList'); 
    if (!window.currentVisit.procs.length) { 
        container.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm italic border-2 border-dashed border-gray-200 rounded-xl bg-gray-50">Ch∆∞a ch·ªçn th·ªß thu·∫≠t</div>`; 
        return; 
    } 
    container.innerHTML = window.currentVisit.procs.map((p, i) => `
        <div class="proc-card">
            <button onclick="window.removeProcedure(${i})" class="proc-del-btn">&times;</button>
            <div class="flex justify-between items-end mb-3 border-b border-dashed border-gray-200 pb-2">
                <span class="font-bold text-[#3e2723] text-lg">${p.name}</span>
                <span class="text-xs text-gray-400 font-mono">${p.price.toLocaleString()}ƒë/l·∫ßn</span>
            </div>
            <div class="grid grid-cols-3 gap-3 mb-3">
                <div class="proc-input-group">
                    <label>S·ªë ng√†y</label>
                    <input type="text" value="${p.days||1}" onfocus="this.select()" onclick="window.openNumberPad && window.openNumberPad(null, 'S·ªë ng√†y', '1-100', ${p.days||1}, (val)=>{window.updateProcDays(${i}, val)})" readonly class="proc-input text-center font-bold">
                </div>
                <div class="proc-input-group">
                    <label>Gi·∫£m (%)</label>
                    <input type="text" value="${p.discount||0}" onfocus="this.select()" onclick="window.openNumberPad && window.openNumberPad(null, 'Gi·∫£m (%)', '0-100', ${p.discount||0}, (val)=>{window.updateProcDiscount(${i}, val)})" readonly class="proc-input text-center text-blue-600 font-bold border-dashed">
                </div>
                <div class="proc-input-group">
                    <label>Th√†nh ti·ªÅn</label>
                    <div class="proc-total-display flex items-center justify-center font-bold text-[#3e2723] bg-gray-100 rounded-lg h-[40px]">
                        ${Math.round(p.price*(p.days||1)*(1-(p.discount||0)/100)).toLocaleString()}
                    </div>
                </div>
            </div>
            <div class="med-usage-row mb-3">
                ${['S√°ng','Tr∆∞a','Chi·ªÅu','T·ªëi'].map(t => `<button class="time-btn-large ${(p.note||'').includes(t)?'active':''}" onclick="window.toggleProcNote(${i},'${t}')">${t}</button>`).join('')}
            </div>
            <input type="text" value="${p.note||''}" onchange="window.updateProcNoteText(${i}, this.value)" placeholder="Ghi ch√∫..." class="w-full text-xs py-2 border-b border-dashed border-gray-300 outline-none bg-transparent">
        </div>
    `).join(''); 
};

window.removeProcedure = function(i) { 
    if(confirm("X√≥a th·ªß thu·∫≠t n√†y?")) { 
        window.currentVisit.procs.splice(i,1); 
        window.renderProcList(); 
        window.calcTotal(); 
    } 
};

window.updateProcDays = function(i,v) { 
    window.currentVisit.procs[i].days = parseInt(v)||0; 
    window.renderProcList(); 
    window.calcTotal(); 
};

window.updateProcDiscount = function(i,v) { 
    let d=parseInt(v)||0; if(d>100) d=100; 
    window.currentVisit.procs[i].discount=d; 
    window.renderProcList(); 
    window.calcTotal(); 
};

window.toggleProcNote = function(i,t) { 
    let p = window.currentVisit.procs[i]; 
    let parts = (p.note||'').split(',').map(s=>s.trim()).filter(s=>s); 
    let k=['S√°ng','Tr∆∞a','Chi·ªÅu','T·ªëi']; 
    let tp=parts.filter(x=>k.includes(x)); 
    let op=parts.filter(x=>!k.includes(x)); 
    if(tp.includes(t)) tp=tp.filter(x=>x!==t); 
    else tp.push(t); 
    tp.sort((a,b)=>k.indexOf(a)-k.indexOf(b)); 
    p.note=[...tp,...op].join(', '); 
    window.renderProcList(); 
};

window.updateProcNoteText = function(i,v) { 
    window.currentVisit.procs[i].note = v; 
};

// --- 10. T√çNH TO√ÅN T·ªîNG ---
window.calcTotal = function() {
    let procTotal = 0; 
    window.currentVisit.procs.forEach(p => { 
        procTotal += Math.round((p.price||0)*(p.days||1)*(1-(p.discount||0)/100)); 
    });
    
    let eastTotal = 0, eastDays = parseInt(document.getElementById('vEastDays').value)||1, eastManual = parseInt(document.getElementById('vEastManualPrice').value)||0; 
    window.currentVisit.eastDays = eastDays;
    eastTotal = eastManual > 0 ? eastManual * eastDays : window.currentVisit.rxEast.reduce((a,m)=>a+((m.qty||0)*(m.price||0)),0) * eastDays;
    
    let westTotal = 0, westDays = parseInt(document.getElementById('vWestDays').value)||1, westManual = parseInt(document.getElementById('vWestManualPrice').value)||0; 
    window.currentVisit.westDays = westDays;
    westTotal = westManual > 0 ? westManual * westDays : window.currentVisit.rxWest.reduce((a,m)=>a+((m.qty||0)*(m.price||0)),0) * westDays;
    
    window.currentVisit.manualMedTotalEast = eastTotal; 
    window.currentVisit.manualMedTotalWest = westTotal;
    
    document.getElementById('displayMedTotalEast').innerText = eastTotal.toLocaleString()+'ƒë'; 
    document.getElementById('displayMedTotalWest').innerText = westTotal.toLocaleString()+'ƒë'; 
    document.getElementById('displayProcTotal').innerText = procTotal.toLocaleString()+'ƒë';
    
    const total = eastTotal + westTotal + procTotal; 
    document.getElementById('displayGrandTotal').innerText = total.toLocaleString()+'ƒë';
    
    const disc = parseInt(document.getElementById('vDiscountPercent').value)||0; 
    document.getElementById('finalTotal').innerText = Math.round(total*(1-disc/100)).toLocaleString()+'ƒë';
    
    ['east','west'].forEach(t=>{ 
        const d = t==='east'?eastDays:westDays, ms = t==='east'?window.currentVisit.rxEast:window.currentVisit.rxWest; 
        const c = document.getElementById(t==='east'?'vMedListEast':'vMedListWest'); 
        if(c) Array.from(c.children).forEach((el,i)=>{ 
            if(ms[i]) { 
                const td=el.querySelector('.proc-total-display'); 
                if(td) td.innerText=((ms[i].qty||0)*(ms[i].price||0)*d).toLocaleString(); 
            }
        }); 
    });
};

// --- 11. C√ÅC N√öT B·ªî TR·ª¢ ---
window.injectCustomButtons = function() {
    const s3 = document.getElementById('step3'); 
    if(s3 && !document.getElementById('btnProcOnly')) { 
        const d = document.createElement('div'); d.className='mb-4'; 
        d.innerHTML=`<button id="btnProcOnly" onclick="window.setOnlyProcedures()" class="w-full py-3 bg-teal-50 text-teal-700 font-bold rounded-xl border border-teal-200 shadow-sm uppercase text-sm hover:bg-teal-100 transition-colors">‚ú® Ch·ªâ l√†m th·ªß thu·∫≠t (X√≥a thu·ªëc)</button>`; 
        s3.insertBefore(d, s3.firstChild); 
    }
    const eastSection = document.getElementById('vMedListEast').parentElement; 
    if (eastSection) { 
        const headerControls = eastSection.querySelector('.rx-header-controls'); 
        if (headerControls && !document.getElementById('btnClearEast')) { 
            const titleDiv = headerControls.firstElementChild; 
            if(titleDiv) { 
                const btn = document.createElement('button'); btn.id = 'btnClearEast'; 
                btn.className = 'text-[10px] bg-gray-200 text-gray-600 px-2 py-1 rounded ml-2 hover:bg-gray-300 font-bold border border-gray-300'; 
                btn.innerText = '‚úò B·ªè toa n√†y'; 
                btn.onclick = function() { window.clearRx('east'); }; 
                titleDiv.appendChild(btn); 
            } 
        } 
    }
    const westSection = document.getElementById('vMedListWest').parentElement; 
    if (westSection) { 
        const headerControls = westSection.querySelector('.rx-header-controls'); 
        if (headerControls && !document.getElementById('btnClearWest')) { 
            const titleDiv = headerControls.firstElementChild; 
            if(titleDiv) { 
                const btn = document.createElement('button'); btn.id = 'btnClearWest'; 
                btn.className = 'text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded ml-2 hover:bg-blue-200 font-bold border border-blue-200'; 
                btn.innerText = '‚úò B·ªè toa n√†y'; 
                btn.onclick = function() { window.clearRx('west'); }; 
                titleDiv.appendChild(btn); 
            } 
        } 
    }
};

window.setOnlyProcedures = function() { 
    if(confirm("X√≥a to√†n b·ªô thu·ªëc?")) { 
        window.clearRx('east',false); 
        window.clearRx('west',false); 
    } 
};

window.clearRx = function(type, ask=true) { 
    if(ask && !confirm("X√≥a thu·ªëc?")) return; 
    if(type==='east') { 
        window.currentVisit.rxEast=[]; 
        window.currentVisit.eastDays=1; 
        document.getElementById('vEastDays').value=1; 
        document.getElementById('vEastManualPrice').value=""; 
        document.getElementById('vEastNote').value=""; 
    } else { 
        window.currentVisit.rxWest=[]; 
        window.currentVisit.westDays=1; 
        document.getElementById('vWestDays').value=1; 
        document.getElementById('vWestManualPrice').value=""; 
        document.getElementById('vWestNote').value=""; 
    } 
    window.renderMedList(type); 
    window.calcTotal(); 
};

// --- 12. L∆ØU & X·ª¨ L√ù (SAVE & PRINT & ZALO) ---
window.saveOnly = function() { window.processSave(false); }; 
window.saveAndPrint = function() { window.processSave(true); };

window.processSave = async function(print) {
    try {
        const pid = document.getElementById('vPid').value; 
        if(!pid) throw new Error("M·∫•t k·∫øt n·ªëi b·ªánh nh√¢n"); 
        window.calcTotal();
        
        const visit = {
            id: parseInt(document.getElementById('vVisitId').value) || Date.now(),
            date: document.getElementById('vDate').value,
            disease: document.getElementById('vDiseaseSelect').value || document.getElementById('vDiseaseInput').value,
            symptoms: document.getElementById('vSpecial').value,
            tuChan: window.currentVisit.tuChan, 
            vong: document.getElementById('vVongExtra').value,
            rxEast: window.currentVisit.rxEast, 
            rxWest: window.currentVisit.rxWest, 
            procs: window.currentVisit.procs, 
            acupoints: window.currentVisit.acupoints,
            eastDays: parseInt(document.getElementById('vEastDays').value) || 1, 
            westDays: parseInt(document.getElementById('vWestDays').value) || 1,
            eastNote: document.getElementById('vEastNote').value, 
            westNote: document.getElementById('vWestNote').value,
            manualPriceEast: parseInt(document.getElementById('vEastManualPrice').value) || 0, 
            manualPriceWest: parseInt(document.getElementById('vWestManualPrice').value) || 0,
            medPriceEast: window.currentVisit.manualMedTotalEast, 
            medPriceWest: window.currentVisit.manualMedTotalWest,
            total: parseInt(document.getElementById('finalTotal').innerText.replace(/[^\d]/g,'')), 
            cost: parseInt(document.getElementById('vCost').value) || 0,
            disc: parseInt(document.getElementById('vDiscountPercent').value) || 0, 
            paid: document.getElementById('vPaid').checked
        };
        
        const pIdx = window.db.findIndex(x => String(x.id) === String(pid));
        if(pIdx > -1) { 
            if(!window.db[pIdx].visits) window.db[pIdx].visits = []; 
            const vIdx = window.db[pIdx].visits.findIndex(v => v.id === visit.id); 
            if(vIdx > -1) window.db[pIdx].visits[vIdx] = visit; 
            else window.db[pIdx].visits.unshift(visit); 
            
            if(window.saveDb) await window.saveDb(); 
            
            if(print) { 
                if(window.preparePrint) window.preparePrint('invoice'); 
            } else { 
                if(window.showToast) window.showToast("‚úÖ ƒê√£ l∆∞u!", "success"); 
                else alert("ƒê√£ l∆∞u!"); 
                if(window.closeModals) window.closeModals(); 
                if(window.render) window.render(); 
            } 
        }
    } catch(e) { 
        console.error(e); 
        alert("L·ªói: " + e.message); 
    }
};

window.copyToZalo = function() {
    try {
        const pName = document.getElementById('vPatientName').innerText;
        const disease = document.getElementById('vDiseaseSelect').value || document.getElementById('vDiseaseInput').value;
        const symptoms = document.getElementById('vSpecial').value;
        
        let msg = `üè• *PH√íNG KH√ÅM YHCT*\n----------------\nüë§ BN: ${pName}\nü©∫ Ch·∫©n ƒëo√°n: ${disease}\n`;
        if(symptoms) msg += `üìù Tri·ªáu ch·ª©ng: ${symptoms}\n`;
        msg += `----------------\n`;
        
        if (window.currentVisit.rxEast && window.currentVisit.rxEast.length > 0) {
            msg += `üåø *ƒê∆†N THU·ªêC ƒê√îNG Y* (${document.getElementById('vEastDays').value} thang)\n`;
            window.currentVisit.rxEast.forEach((m, i) => { msg += `${i+1}. ${m.name}: ${m.qty}g\n`; });
            const noteE = document.getElementById('vEastNote').value; 
            if(noteE) msg += `üí° HDSD: ${noteE}\n`; 
            msg += `\n`;
        }
        
        if (window.currentVisit.rxWest && window.currentVisit.rxWest.length > 0) {
            msg += `üíä *ƒê∆†N THU·ªêC T√ÇY Y* (${document.getElementById('vWestDays').value} ng√†y)\n`;
            window.currentVisit.rxWest.forEach((m, i) => { msg += `${i+1}. ${m.name} (${m.qty} vi√™n): ${m.usage || ''}\n`; });
            const noteW = document.getElementById('vWestNote').value; 
            if(noteW) msg += `üí° L·ªùi d·∫∑n: ${noteW}\n`; 
            msg += `\n`;
        }
        
        const total = document.getElementById('finalTotal').innerText;
        msg += `üí∞ *T·ªïng thanh to√°n:* ${total}\nüóì Ng√†y kh√°m: ${document.getElementById('vDate').value}\n----------------\nC·∫£m ∆°n qu√Ω kh√°ch!`;
        
        navigator.clipboard.writeText(msg).then(() => { 
            if(window.showToast) window.showToast("‚úÖ ƒê√£ copy Zalo!", "success"); 
            else alert("ƒê√£ copy Zalo!"); 
        }).catch(err => { 
            console.error(err); 
            alert("L·ªói copy!"); 
        });
    } catch (e) { 
        alert("L·ªói Zalo: " + e.message); 
    }
};

setTimeout(() => { if(window.updateYunQiDisplay) window.updateYunQiDisplay(); }, 1000);
// --- TH√äM V√ÄO CU·ªêI FILE visit.js HO·∫∂C THAY TH·∫æ C√ÅC H√ÄM C≈® ---

// 1. Logic n√∫t th·ªùi gian chung (Ghi ch√∫)
window.toggleGlobalEastUsage = function(timeStr) { 
    const el = document.getElementById('vEastNote'); 
    let currentText = el.value || '';
    let parts = currentText.split(',').map(s => s.trim()).filter(s => s); 
    const keywords = ['S√°ng','Tr∆∞a','Chi·ªÅu','T·ªëi']; 
    
    let timeParts = parts.filter(x => keywords.includes(x)); 
    let otherParts = parts.filter(x => !keywords.includes(x)); 
    
    if (timeParts.includes(timeStr)) timeParts = timeParts.filter(t => t !== timeStr); 
    else timeParts.push(timeStr); 
    
    timeParts.sort((a,b) => keywords.indexOf(a) - keywords.indexOf(b)); 
    el.value = [...otherParts, ...timeParts].join(', '); 
    
    window.syncGlobalTimeButtons(timeParts);
};

window.syncGlobalTimeButtons = function(activeTimes) {
    const container = document.getElementById('globalEastTimeGroup');
    if(!container) return;
    Array.from(container.children).forEach(btn => {
        const btnText = btn.innerText.trim();
        if(activeTimes.includes(btnText)) btn.classList.add('active'); 
        else btn.classList.remove('active');
    });
};

window.updateGlobalButtonsFromText = function() {
    const el = document.getElementById('vEastNote');
    if(!el) return;
    const text = el.value || '';
    const keywords = ['S√°ng','Tr∆∞a','Chi·ªÅu','T·ªëi'];
    const activeTimes = keywords.filter(k => text.includes(k));
    window.syncGlobalTimeButtons(activeTimes);
};