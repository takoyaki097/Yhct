<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QU·∫¢N L√ù PH√íNG KH√ÅM YHCT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --emerald-dark: #064e3b; --emerald-light: #ecfdf5; }
        body { background-color: #f3f4f6; font-family: -apple-system, sans-serif; overflow-x: hidden; }
        
        /* Hi·ªáu ·ª©ng vu·ªët ƒë·ªÉ x√≥a */
        .swipe-container { position: relative; overflow: hidden; border-radius: 20px; margin-bottom: 1rem; background: #ef4444; }
        .patient-card { 
            background: white; 
            position: relative; 
            z-index: 2; 
            transition: transform 0.3s ease; 
            cursor: grab;
            touch-action: pan-y;
        }
        .delete-btn { 
            position: absolute; 
            right: 0; 
            top: 0; 
            bottom: 0; 
            width: 80px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold;
            z-index: 1;
        }

        /* C√°c style gi·ªØ nguy√™n t·ª´ b·∫£n c≈© */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        input, textarea { border: 1px solid #d1d5db; border-radius: 12px; padding: 15px; width: 100%; font-size: 17px; outline: none; }
        .btn-tag { padding: 8px 14px; border-radius: 10px; border: 1px solid #e5e7eb; font-size: 14px; background: white; margin: 3px; }
        .btn-tag.active { background: #065f46; color: white; border-color: #065f46; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-2xl mx-auto">
        <div class="bg-emerald-900 text-white p-6 rounded-[25px] mb-6 shadow-xl flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black text-yellow-400">YHCT iPAD PRO</h1>
                <p id="monthLabel" class="text-[10px] opacity-70 font-bold uppercase mt-1"></p>
            </div>
            <div class="text-right">
                <p id="profitLabel" class="text-2xl font-black text-green-400">0ƒë</p>
                <p class="text-[9px] uppercase opacity-50 font-bold">L·ª£i nhu·∫≠n</p>
            </div>
        </div>

        <div class="flex gap-2 mb-6">
            <button onclick="openPatientModal()" class="flex-grow bg-emerald-700 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-transform uppercase text-sm">+ B·ªánh nh√¢n m·ªõi</button>
            <button onclick="exportData()" class="bg-white border-2 border-emerald-800 text-emerald-800 px-4 rounded-2xl font-bold text-xs shadow-sm">XU·∫§T FILE</button>
        </div>

        <input type="text" id="search" oninput="render()" placeholder="T√¨m t√™n ho·∫∑c s·ªë ƒëi·ªán tho·∫°i..." class="mb-6 shadow-sm">
        
        <p class="text-[10px] text-gray-400 mb-2 italic ml-2">Vu·ªët sang tr√°i ƒë·ªÉ x√≥a b·ªánh nh√¢n</p>
        <div id="list" class="space-y-0"></div>
    </div>

    <div id="pModal" class="modal"><div class="bg-white w-full max-w-md p-6 rounded-3xl shadow-2xl">
        <h2 class="font-bold text-emerald-900 mb-4 uppercase border-b pb-2">H·ªì s∆° b·ªánh nh√¢n</h2>
        <input type="hidden" id="editId">
        <div class="space-y-3">
            <input type="text" id="pName" placeholder="H·ªç t√™n *">
            <div class="flex gap-2"><input type="number" id="pYear" placeholder="NƒÉm sinh *"><input type="tel" id="pPhone" placeholder="SƒêT"></div>
            <input type="text" id="pAddress" placeholder="ƒê·ªãa ch·ªâ">
        </div>
        <div class="flex gap-2 mt-6">
            <button onclick="closeModals()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-400">ƒê√ìNG</button>
            <button onclick="savePatient()" class="flex-1 py-3 bg-emerald-800 text-white rounded-xl font-bold shadow-md">L∆ØU L·∫†I</button>
        </div>
    </div></div>

    <div id="vModal" class="modal"><div class="bg-white w-full max-w-xl p-6 rounded-3xl shadow-2xl overflow-y-auto max-h-[90vh]">
        <h2 class="font-bold text-emerald-900 mb-4 uppercase border-b pb-2">Phi·∫øu kh√°m b·ªánh</h2>
        <input type="hidden" id="vPid">
        <div class="space-y-4">
            <div class="flex gap-2"><input type="date" id="vDate" class="flex-1"><input type="text" id="vDisease" placeholder="Ch·∫©n ƒëo√°n..." class="flex-[2]"></div>
            <div id="tagBox" class="p-3 bg-gray-50 rounded-2xl border"></div>
            <textarea id="vMed" placeholder="ƒê∆°n thu·ªëc, huy·ªát v·ªã..." rows="3"></textarea>
            <div class="grid grid-cols-2 gap-3">
                <input type="number" id="vPrice" placeholder="Gi√° thu" oninput="calcV()"><input type="number" id="vCost" placeholder="Gi√° v·ªën">
            </div>
            <div class="bg-emerald-900 text-white p-5 rounded-2xl flex justify-between items-center shadow-lg">
                <span class="text-2xl font-black text-yellow-400" id="vTotal">0ƒë</span>
                <label class="flex items-center gap-2 font-bold"><input type="checkbox" id="vPaid" checked class="w-5 h-5"> ƒê√É THU</label>
            </div>
        </div>
        <button onclick="saveVisit()" class="w-full mt-6 py-4 bg-emerald-700 text-white rounded-2xl font-bold shadow-lg">HO√ÄN T·∫§T L∆ØU</button>
    </div></div>

    <div id="hModal" class="modal"><div class="bg-white w-full max-w-xl p-6 rounded-3xl shadow-2xl overflow-y-auto max-h-[90vh]">
        <div class="flex justify-between items-start mb-4 border-b pb-2"><h2 id="hName" class="font-bold text-emerald-900 uppercase"></h2><button onclick="closeModals()" class="text-2xl text-gray-400">‚úï</button></div>
        <div id="hContent" class="space-y-4"></div>
    </div></div>

    <script>
        let db = JSON.parse(localStorage.getItem('yhct_db_v4') || '[]');
        const sampleTags = ['ƒêau c·ªï vai g√°y', 'Tho√°i h√≥a c·ªôt s·ªëng', 'M·∫•t ng·ªß', 'T√™ b√¨', 'L∆∞·ª°i ƒë·ªè', 'R√™u v√†ng'];

        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
        
        // --- X·ª¨ L√ù VU·ªêT ƒê·ªÇ X√ìA ---
        let startX = 0;
        function handleTouchStart(e) { startX = e.touches[0].clientX; }
        function handleTouchMove(e, id) {
            let moveX = e.touches[0].clientX;
            let diff = startX - moveX;
            let card = document.getElementById('card-' + id);
            if (diff > 50) { // Vu·ªët sang tr√°i
                card.style.transform = `translateX(-80px)`;
            } else if (diff < -20) { // Vu·ªët sang ph·∫£i ƒë·ªÉ ƒë√≥ng
                card.style.transform = `translateX(0px)`;
            }
        }

        function confirmDelete(id, name) {
            if (confirm(`‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA Vƒ®NH VI·ªÑN b·ªánh nh√¢n: ${name.toUpperCase()}?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
                db = db.filter(x => x.id != id);
                localStorage.setItem('yhct_db_v4', JSON.stringify(db));
                render();
            } else {
                // N·∫øu kh√¥ng x√≥a th√¨ ƒë√≥ng thanh tr∆∞·ª£t l·∫°i
                document.getElementById('card-' + id).style.transform = `translateX(0px)`;
            }
        }

        // --- C√ÅC H√ÄM C≈® GI·ªÆ NGUY√äN ---
        function openPatientModal(id = null) {
            document.getElementById('editId').value = id || '';
            if(id) {
                let p = db.find(x => x.id == id);
                document.getElementById('pName').value = p.name;
                document.getElementById('pYear').value = p.year;
                document.getElementById('pPhone').value = p.phone || '';
                document.getElementById('pAddress').value = p.address || '';
            } else {
                document.querySelectorAll('#pModal input').forEach(i => i.value = '');
            }
            document.getElementById('pModal').classList.add('active');
        }

        function savePatient() {
            let id = document.getElementById('editId').value;
            let name = document.getElementById('pName').value;
            if(!name) return alert("Vui l√≤ng nh·∫≠p t√™n");
            let p = {
                id: id || Date.now().toString(),
                name: name,
                year: document.getElementById('pYear').value,
                phone: document.getElementById('pPhone').value,
                address: document.getElementById('pAddress').value,
                visits: id ? db.find(x => x.id == id).visits : []
            };
            if(id) { let i = db.findIndex(x => x.id == id); db[i] = p; }
            else { db.unshift(p); }
            localStorage.setItem('yhct_db_v4', JSON.stringify(db));
            render(); closeModals();
        }

        function openVisitModal(pid) {
            document.getElementById('vPid').value = pid;
            document.getElementById('vDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('vDisease').value = '';
            document.getElementById('vMed').value = '';
            document.getElementById('vPrice').value = '';
            document.getElementById('vCost').value = '';
            document.getElementById('tagBox').innerHTML = sampleTags.map(t => `<button class="btn-tag" onclick="this.classList.toggle('active')">${t}</button>`).join('');
            calcV();
            document.getElementById('vModal').classList.add('active');
        }

        function calcV() {
            let p = parseInt(document.getElementById('vPrice').value) || 0;
            document.getElementById('vTotal').innerText = p.toLocaleString() + 'ƒë';
        }

        function saveVisit() {
            let pid = document.getElementById('vPid').value;
            let activeTags = Array.from(document.querySelectorAll('#tagBox .btn-tag.active')).map(b => b.innerText);
            let v = {
                id: Date.now(),
                date: document.getElementById('vDate').value,
                disease: document.getElementById('vDisease').value,
                tags: activeTags.join(', '),
                med: document.getElementById('vMed').value,
                price: parseInt(document.getElementById('vPrice').value) || 0,
                cost: parseInt(document.getElementById('vCost').value) || 0,
                paid: document.getElementById('vPaid').checked
            };
            let i = db.findIndex(x => x.id == pid);
            db[i].visits.unshift(v);
            localStorage.setItem('yhct_db_v4', JSON.stringify(db));
            render(); closeModals();
        }

        function showHistory(pid) {
            let p = db.find(x => x.id == pid);
            document.getElementById('hName').innerText = p.name;
            document.getElementById('hContent').innerHTML = p.visits.map(v => `
                <div class="p-4 bg-gray-50 rounded-2xl border shadow-sm">
                    <div class="flex justify-between font-bold text-emerald-800 text-xs mb-2 border-b border-dashed pb-2">
                        <span>${v.date}</span><span>${v.price.toLocaleString()}ƒë</span>
                    </div>
                    <p class="font-bold text-sm uppercase">${v.disease}</p>
                    <p class="text-xs text-gray-500 italic mt-1">${v.tags}</p>
                    <p class="text-xs mt-2 bg-white p-2 rounded-lg border">ƒê∆†N: ${v.med || '-'}</p>
                </div>
            `).join('') || '<p class="text-center text-gray-400 py-10">Ch∆∞a c√≥ l·ªãch s·ª≠</p>';
            document.getElementById('hModal').classList.add('active');
        }

        function render() {
            let list = document.getElementById('list');
            let kw = document.getElementById('search').value.toLowerCase();
            let profit = 0;
            let curM = (new Date().getMonth() + 1) + '/' + new Date().getFullYear();
            
            list.innerHTML = '';
            db.forEach(p => {
                p.visits.forEach(v => {
                    let vd = new Date(v.date);
                    if(v.paid && (vd.getMonth()+1 + '/' + vd.getFullYear() == curM)) profit += (v.price - v.cost);
                });

                if(p.name.toLowerCase().includes(kw) || p.phone.includes(kw)) {
                    let last = p.visits[0] ? p.visits[0].disease : 'Ch∆∞a kh√°m';
                    list.innerHTML += `
                    <div class="swipe-container shadow-sm border border-gray-100">
                        <div class="delete-btn" onclick="confirmDelete('${p.id}', '${p.name}')">
                            <span class="text-xl">üóëÔ∏è</span>
                        </div>
                        <div id="card-${p.id}" class="patient-card p-5 flex justify-between items-center" 
                             ontouchstart="handleTouchStart(event)" 
                             ontouchmove="handleTouchMove(event, '${p.id}')">
                            <div onclick="showHistory('${p.id}')" class="flex-grow">
                                <h3 class="font-black text-emerald-950 uppercase tracking-tight">${p.name}</h3>
                                <p class="text-[10px] text-gray-400 font-bold uppercase mt-1">${p.phone || 'N/A'} ‚Ä¢ SINH: ${p.year}</p>
                                <p class="text-[11px] text-emerald-600 font-bold mt-2 bg-emerald-50 inline-block px-3 py-1 rounded-full uppercase">G·∫ßn nh·∫•t: ${last}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openPatientModal('${p.id}')" class="p-3 bg-gray-50 rounded-xl">‚úé</button>
                                <button onclick="openVisitModal('${p.id}')" class="bg-emerald-800 text-white px-5 py-3 rounded-xl font-bold text-xs uppercase shadow-md">Kh√°m</button>
                            </div>
                        </div>
                    </div>`;
                }
            });
            document.getElementById('profitLabel').innerText = profit.toLocaleString() + 'ƒë';
            document.getElementById('monthLabel').innerText = 'D·ªØ li·ªáu th√°ng ' + curM;
        }

        function exportData() {
            let csv = "\uFEFFNg√†y,B·ªánh nh√¢n,SƒêT,B·ªánh,T·ªïng ti·ªÅn,ƒê∆°n thu·ªëc\n";
            db.forEach(p => p.visits.forEach(v => {
                csv += `"${v.date}","${p.name}","${p.phone}","${v.disease}","${v.price}","${v.med}"\n`;
            }));
            let blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "BC_YHCT_" + new Date().toLocaleDateString() + ".csv";
            link.click();
        }

        render();
    </script>
</body>
</html>
