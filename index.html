<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="YHCT Pro">
    <meta name="theme-color" content="#5d4037"> 
    <meta name="format-detection" content="telephone=no">
    
    <link rel="apple-touch-icon" href="icon.png">
    
    <title>YHCT Pro - Qu·∫£n l√Ω Ph√≤ng Kh√°m</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Serif:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/core.css">       
    <link rel="stylesheet" href="css/main-ui.css">    
    <link rel="stylesheet" href="css/bioclock.css">

    <style>
        /* CSS n·ªôi b·ªô cho m√†n h√¨nh Loading */
        #globalLoader { position: fixed; inset: 0; z-index: 99999; background: #f2ebe0; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .loader-spinner { width: 50px; height: 50px; border: 4px solid #d7ccc8; border-top: 4px solid #5d4037; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="globalLoader">
        <div class="loader-spinner"></div>
        <p style="font-weight: bold; color: #5d4037; font-family: 'Noto Serif', serif;">ƒêang t·∫£i d·ªØ li·ªáu YHCT...</p>
    </div>

    <div class="max-w-3xl mx-auto relative opacity-0 transition-opacity duration-500" id="mainAppContent">
        
        <div id="mainHeader">
            <div id="headerOverlay"></div>
            
            <div id="mainHeaderCard" class="header-card grid grid-cols-[1fr_auto] gap-4 items-center overflow-hidden">
                
                <div class="flex flex-col justify-center space-y-2 min-w-0 pr-4 border-r border-dashed header-sep-line">
                    <div class="border-b border-dashed header-sep-line pb-2">
                        <h1 id="displayTitle" class="text-xl md:text-2xl font-black uppercase tracking-wide leading-tight text-ellipsis overflow-hidden whitespace-nowrap">
                            Ph√≤ng Kh√°m
                        </h1>
                    </div>
                    <div id="displayDoctor" class="leading-tight truncate">
                        <span class="text-[10px] font-bold uppercase block opacity-80 mb-0.5">Xin ch√†o,</span>
                        <span class="font-black text-lg truncate block">BS. ƒê√¥ng Y</span>
                    </div>
                    <div id="headerInfoBox" class="header-info-box bg-[#3e2723]/5 rounded-xl p-2 text-[10px] md:text-xs space-y-1 border border-[#3e2723]/10 transition-all duration-300">
                        <div class="flex justify-between gap-2"><span class="font-bold w-12 text-right opacity-70">D∆∞∆°ng:</span><span id="headerDate" class="font-mono font-bold truncate">--/--</span></div>
                        <div class="flex justify-between gap-2"><span class="font-bold w-12 text-right opacity-70">√Çm:</span><span id="headerLunar" class="font-bold truncate">...</span></div>
                        <div class="flex justify-between gap-2"><span class="font-bold w-12 text-right opacity-70">V·∫≠n:</span><span id="headerYunQi" class="font-bold truncate">...</span></div>
                        <div class="flex justify-between gap-2"><span class="font-bold w-12 text-right opacity-70">Gi·ªù:</span><span id="headerZiWu" class="font-bold truncate">...</span></div>
                    </div>
                </div>

                <div class="w-36 md:w-44 flex flex-col justify-center pointer-events-auto flex-shrink-0" onclick="window.handleProfitBoxClick()">
                    <p id="monthLabel" class="text-[9px] font-black uppercase text-center mb-1 tracking-[1px]">DOANH THU TH√ÅNG</p>
                    <div id="profitBoxContainer" class="bg-white/50 border-2 border-[#3e2723]/10 px-1 py-4 rounded-xl text-center cursor-pointer hover:bg-[#3e2723]/5 transition-all shadow-sm flex items-center justify-center flex-col h-24">
                        <div id="profitLabel" class="font-mono text-xl md:text-2xl tracking-tighter font-black break-all line-clamp-1">******</div>
                        <div class="text-[9px] uppercase font-bold opacity-50 mt-1">VNƒê</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="menuContainer">
            <div class="relative mb-6" id="searchArea">
                <input type="text" id="search" onkeyup="window.debouncedRender()" placeholder="üîç T√¨m t√™n ho·∫∑c s·ªë ƒëi·ªán tho·∫°i..." class="ipad-input-fix text-[#3e2723] outline-none">
            </div>
            
            <div class="grid grid-cols-5 gap-3 mb-6 relative z-30">
                <button type="button" onclick="window.openPatientModal()" class="col-span-2 btn-glass py-4 uppercase text-xs text-[#3e2723] flex flex-col items-center gap-1 hover:bg-white/90">
                    <span class="text-xl">‚ûï</span> B·ªánh nh√¢n
                </button>
                
                <button type="button" onclick="InventoryTpl.open()" class="col-span-1 btn-glass py-4 uppercase text-xs text-[#3e2723] flex flex-col items-center gap-1 hover:bg-white/90">
                    <span class="text-xl">üì¶</span> Kho
                </button>

                <button type="button" onclick="window.openStats()" class="col-span-1 btn-glass py-4 uppercase text-xs text-[#3e2723] flex flex-col items-center gap-1 hover:bg-white/90">
                    <span class="text-xl">üìä</span> B√°o c√°o
                </button>
                
                <button type="button" onclick="window.openSettings()" class="btn-glass text-2xl text-[#5d4037] hover:bg-white/90">‚öôÔ∏è</button>
            </div>
            
            <div id="monthFilterArea" class="relative z-30"></div>
            <div id="list" class="space-y-3 pb-24 relative z-25"></div>
        </div>
    </div>

    <script src="configs/config-core.js"></script>
    <script src="configs/config-header.js"></script>
    <script src="configs/config-settings-ui.js"></script>
    <script src="configs/config-disease.js"></script>
    <script src="configs/config-procedures.js"></script>
    <script src="configs/config-medicine.js"></script>
    
    <script src="knowledge/knowledge.js"></script>
    <script src="knowledge/database.js"></script>
    <script src="knowledge/knowledge-time.js"></script>
    <script src="knowledge/knowledge-ziwu.js"></script>
    <script src="knowledge/knowledge-ai.js"></script>

    <script src="knowledge_data/acu-meridians-1.js"></script>
    <script src="knowledge_data/acu-meridians-2.js"></script>
    <script src="knowledge_data/acu-extra-vessels.js"></script>
    <script src="knowledge_data/acu-extra-points.js"></script>
    <script src="knowledge_data/herbs-data.js"></script> 
    <script src="knowledge_data/knowledge-med-extended.js"></script>

    <script src="templates/tpl-visit.js"></script>     
    <script src="templates/tpl-patient.js"></script>   
    <script src="templates/tpl-modal-report.js"></script> 
    <script src="templates/tpl-modal-lookup.js"></script> 
    <script src="templates/tpl-modal-clock.js"></script>  
    <script src="templates/tpl-modal-herb.js"></script> 
    <script src="templates/tpl-inventory.js"></script>
    <script src="templates/tpl-modal-sample.js"></script>

    <script src="tpl-settings/tab-ui.js"></script>
    <script src="tpl-settings/tab-med.js"></script>
    <script src="tpl-settings/tab-system.js"></script>
    <script src="tpl-settings/sub-modals.js"></script>
    <script src="tpl-settings/index.js"></script>

    <script src="templates/template-loader.js"></script>

    <script src="modules_core/ui-helper.js"></script>
    <script src="modules_core/inventory.js"></script>
    <script src="modules_core/patient.js"></script>
    <script src="modules_core/report.js"></script>
    <script src="modules_core/knowledge-base-ui.js"></script>
    <script src="modules_core/knowledge-bridge.js"></script>
    <script src="modules_core/main.js"></script>
    
    <script src="modules_visit/visit-core.js"></script>
    <script src="modules_visit/visit-map.js"></script>
    <script src="modules_visit/visit-meds.js"></script>
    <script src="modules_visit/visit-procs.js"></script>
    <script src="modules_visit/visit-finish.js"></script>

    <script>
        // A. Kh·ªüi t·∫°o Template (N·∫°p HTML v√†o trang)
        if(window.loadAllModals) {
            window.loadAllModals();
        } else {
            console.error("L·ªói: Kh√¥ng t√¨m th·∫•y template-loader.js! Ki·ªÉm tra l·∫°i th∆∞ m·ª•c 'templates'.");
        }

        // B. X·ª≠ l√Ω Loader (T·∫Øt m√†n h√¨nh ch·ªù)
        window.addEventListener('load', function() {
            setTimeout(() => {
                const loader = document.getElementById('globalLoader');
                const content = document.getElementById('mainAppContent');
                if(loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 500);
                }
                if(content) {
                    content.classList.remove('opacity-0');
                }
            }, 800); 
            
            // Kh·ªüi t·∫°o Kho (Inventory) n·∫øu ch∆∞a ch·∫°y
            if(window.Inventory && window.Inventory.init) {
                window.Inventory.init();
            }
        });

        // C. X·ª≠ l√Ω nh·∫≠p file Backup (JSON)
        window.handleJSONFileSelect = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const jsonContent = JSON.parse(e.target.result);
                    
                    if (!jsonContent.db && !jsonContent.config) {
                        alert("‚ùå L·ªói: File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng d·ªØ li·ªáu ph√≤ng kh√°m!");
                        return;
                    }

                    if (confirm("T√¨m th·∫•y b·∫£n sao l∆∞u h·ª£p l·ªá!\n\nB·∫°n c√≥ mu·ªën kh√¥i ph·ª•c d·ªØ li·ªáu kh√¥ng?\n(D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã thay th·∫ø)")) {
                        if (jsonContent.db) {
                            window.db = jsonContent.db;
                            await localforage.setItem('yhct_db_v49', window.db);
                        }
                        if (jsonContent.config) {
                            const oldBg = window.config ? window.config.headerBgImage : null;
                            const oldQr = window.config ? window.config.qrCodeImage : null;
                            window.config = { ...window.defaultConfig, ...jsonContent.config };
                            // Gi·ªØ l·∫°i ·∫£nh c≈© n·∫øu file backup kh√¥ng c√≥
                            if (!window.config.headerBgImage && oldBg) window.config.headerBgImage = oldBg;
                            if (!window.config.qrCodeImage && oldQr) window.config.qrCodeImage = oldQr;
                            await localforage.setItem('yhct_cfg_v49', window.config);
                        }
                        // Kh√¥i ph·ª•c Kho
                        if (jsonContent.inventory) {
                            await localforage.setItem('yhct_inventory', jsonContent.inventory);
                            if(window.Inventory && window.Inventory.init) await window.Inventory.init();
                        }

                        alert("‚úÖ Kh√¥i ph·ª•c th√†nh c√¥ng! ·ª®ng d·ª•ng s·∫Ω t·ª± t·∫£i l·∫°i.");
                        window.location.reload();
                    }
                } catch (err) {
                    console.error(err);
                    alert("‚ùå L·ªói khi ƒë·ªçc file: " + err.message);
                } finally {
                    event.target.value = ''; 
                }
            };
            reader.onerror = function() { alert("L·ªói: Tr√¨nh duy·ªát kh√¥ng th·ªÉ ƒë·ªçc file n√†y!"); };
            reader.readAsText(file);
        };
    </script>
</body>
</html>
