<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YHCT - Qu·∫£n L√Ω Ph√≤ng Kh√°m Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #1b4332; --bg: #f4f1ea; }
        body { background-color: var(--bg); font-family: system-ui, -apple-system, sans-serif; color: #374151; }
        .header-custom { position: relative; border-radius: 1.5rem; min-height: 140px; background: #1b4332; overflow: hidden; }
        #headerBg { position: absolute; inset: 0; background-size: cover; background-position: center; filter: brightness(0.4) blur(1px); z-index: 1; }
        .header-content { position: relative; z-index: 10; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }
        input, textarea, select { border: 1px solid #d1d5db; border-radius: 8px; padding: 10px; width: 100%; outline: none; font-size: 14px; }
        
        .btn-tag { padding: 6px 12px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 12px; background: white; cursor: pointer; transition: 0.2s; white-space: nowrap; }
        .btn-tag.active { background: #10b981; color: white; border-color: #10b981; font-weight: bold; }
        
        .proc-item { display: flex; align-items: center; padding: 10px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; gap: 10px; }
        .proc-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; }
        .proc-item label { font-size: 13px; cursor: pointer; flex-grow: 1; line-height: 1.2; }

        .modal { background: rgba(0,0,0,0.8); display: none; position: fixed; inset: 0; z-index: 100; align-items: center; justify-content: center; padding: 10px; }
        .modal.active { display: flex; }
        .modal-content { max-height: 95vh; overflow-y: auto; width: 100%; }
        .section-title { font-size: 11px; font-weight: bold; color: #065f46; border-left: 4px solid #10b981; padding-left: 8px; margin: 15px 0 8px 0; text-transform: uppercase; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="p-2 md:p-4">

    <div class="max-w-6xl mx-auto mb-4 no-print">
        <div class="header-custom text-white p-6 shadow-xl flex flex-col md:flex-row justify-between items-center">
            <div id="headerBg"></div>
            <div class="header-content text-center md:text-left">
                <h1 class="text-2xl font-black uppercase text-yellow-500">Qu·∫£n L√Ω Ph√≤ng Kh√°m YHCT</h1>
                <p id="currentMonthLabel" class="text-sm opacity-90 mt-1"></p>
            </div>
            <div class="header-content text-center md:text-right mt-4 md:mt-0">
                <p id="totalProfit" class="text-3xl font-bold text-green-400">0ƒë</p>
                <p class="text-[10px] uppercase opacity-70 tracking-widest">L·ª£i nhu·∫≠n th√°ng n√†y</p>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-4 no-print">
        <div class="lg:col-span-4 space-y-4">
            <div class="card p-4">
                <button type="button" onclick="openPatientModal()" class="w-full bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg mb-3 uppercase text-sm">+ Th√™m b·ªánh nh√¢n m·ªõi</button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="openSettingsModal()" class="bg-white border border-emerald-700 text-emerald-700 py-2 rounded-xl text-xs font-bold uppercase">‚öôÔ∏è C√†i ƒë·∫∑t</button>
                    <button onclick="exportCSV()" class="bg-white border border-blue-700 text-blue-700 py-2 rounded-xl text-xs font-bold uppercase">üìä Xu·∫•t File</button>
                </div>
                <input type="text" id="search" oninput="renderPatients()" placeholder="T√¨m t√™n, nƒÉm sinh, SƒêT..." class="mt-4 bg-gray-50 shadow-inner">
            </div>
        </div>
        <div class="lg:col-span-8">
            <div id="patientList" class="space-y-2"></div>
        </div>
    </div>

    <div id="patientModal" class="modal">
        <div class="card modal-content max-w-md p-6">
            <form id="patientForm" class="space-y-4">
                <h2 class="font-bold border-b pb-2 text-emerald-800 uppercase text-lg">H·ªì s∆° b·ªánh nh√¢n</h2>
                <input type="hidden" id="editPatientId">
                <div class="grid grid-cols-1 gap-3">
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">H·ªç v√† T√™n *</label><input type="text" id="pName" placeholder="VD: Nguy·ªÖn VƒÉn A" required></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] font-bold text-gray-500 uppercase">NƒÉm sinh *</label><input type="number" id="pYear" placeholder="VD: 1990" required></div>
                        <div><label class="text-[10px] font-bold text-gray-500 uppercase">S·ªë ƒëi·ªán tho·∫°i</label><input type="tel" id="pPhone" placeholder="09xxx..."></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">ƒê·ªãa ch·ªâ</label><input type="text" id="pAddress" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£..."></div>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" onclick="closeModal('patientModal')" class="bg-gray-200 px-6 py-3 rounded-xl font-bold text-sm uppercase">H·ªßy</button>
                    <button type="submit" class="bg-emerald-700 text-white px-6 py-3 rounded-xl font-bold text-sm uppercase shadow-md">L∆∞u th√¥ng tin</button>
                </div>
            </form>
        </div>
    </div>

    <div id="visitModal" class="modal">
        <div class="card modal-content max-w-3xl p-6">
            <h2 class="text-xl font-bold text-emerald-900 border-b mb-4 uppercase text-center">Kh√°m b·ªánh & Th·ªß thu·∫≠t</h2>
            <form id="visitForm" class="space-y-4">
                <input type="hidden" id="visitPatientId"><input type="hidden" id="editVisitId">
                
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase">Ng√†y kh√°m</label><input type="date" id="visitDate"></div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Ch·∫©n ƒëo√°n</label>
                        <input type="text" id="visitDisease" placeholder="Ch·ªçn b·ªánh ho·∫∑c nh·∫≠p..." required>
                        <div id="diseaseTags" class="flex flex-wrap gap-1 mt-2"></div>
                    </div>
                </div>

                <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                    <div class="section-title mt-0">T·ª© ch·∫©n & Tri·ªáu ch·ª©ng</div>
                    <div class="mb-1 text-[10px] font-bold text-emerald-800">V·ªçng:</div><div id="vongTags" class="flex flex-wrap gap-2 mb-3"></div>
                    <div class="mb-1 text-[10px] font-bold text-emerald-800">VƒÉn:</div><div id="vanTags" class="flex flex-wrap gap-2 mb-3"></div>
                    <div class="mb-1 text-[10px] font-bold text-emerald-800">V·∫•n:</div><div id="vanHoiTags" class="flex flex-wrap gap-2 mb-3"></div>
                    <div class="mb-1 text-[10px] font-bold text-emerald-800">Thi·∫øt:</div><div id="thietTags" class="flex flex-wrap gap-2"></div>
                </div>

                <div id="specificArea" class="hidden p-4 bg-orange-50 border border-orange-200 rounded-xl">
                    <div class="section-title text-orange-800 mt-0">Tri·ªáu ch·ª©ng ƒë·∫∑c th√π b·ªánh</div>
                    <div id="specificTags" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <textarea id="visitMedicine" rows="3" placeholder="ƒê∆°n thu·ªëc (V·ªã thu·ªëc, li·ªÅu l∆∞·ª£ng)..."></textarea>
                    <textarea id="visitNotes" rows="3" placeholder="D·∫∑n d√≤, ghi ch√∫..."></textarea>
                </div>

                <div class="bg-gray-100 p-4 rounded-xl border border-gray-200">
                    <div class="section-title mt-0">Th·ªß thu·∫≠t</div>
                    <div id="procChecklist" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-6">
                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                        <label class="text-[11px] font-bold text-blue-700 uppercase">Chi ph√≠ thu·ªëc</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div><span class="text-[9px]">Gi√° b√°n:</span><input type="number" id="medicinePrice" oninput="calcTotal()"></div>
                            <div><span class="text-[9px]">Gi√° v·ªën:</span><input type="number" id="medicineCost" oninput="calcTotal()"></div>
                        </div>
                    </div>
                    <div class="bg-emerald-900 p-4 rounded-xl text-center text-white shadow-xl">
                        <p class="text-xs opacity-70 uppercase font-bold">T·ªïng thanh to√°n:</p>
                        <p id="visitTotalLabel" class="text-3xl font-black text-yellow-400">0ƒë</p>
                        <div class="flex items-center justify-center gap-3 mt-3">
                            <input type="checkbox" id="visitPaid" checked style="width:24px; height:24px;">
                            <label for="visitPaid" class="text-sm font-bold cursor-pointer uppercase">ƒê√£ thu ti·ªÅn</label>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="closeModal('visitModal')" class="px-6 py-3 bg-gray-200 rounded-xl font-bold uppercase text-xs">ƒê√≥ng</button>
                    <button type="submit" class="px-10 py-3 bg-emerald-700 text-white rounded-xl font-bold shadow-lg uppercase text-xs">L∆∞u h·ªì s∆°</button>
                </div>
            </form>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="card modal-content max-w-3xl p-6">
            <div class="flex justify-between items-start mb-6 border-b pb-4">
                <div>
                    <h2 id="histName" class="text-2xl font-black text-emerald-900 uppercase"></h2>
                    <p id="histDetail" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <button onclick="closeModal('historyModal')" class="text-4xl text-gray-300 hover:text-red-500">&times;</button>
            </div>
            <div id="histContent" class="space-y-4"></div>
        </div>
    </div>

    <div id="settingsModal" class="modal"><div class="card modal-content max-w-2xl p-6"><h2 class="font-bold border-b pb-2 uppercase text-emerald-800">C√†i ƒë·∫∑t</h2><div id="diseaseSettings" class="flex flex-wrap gap-2 py-4 border-b"></div><button onclick="addDiseasePrompt()" class="text-xs text-blue-600 font-bold mb-4 underline">+ Th√™m b·ªánh m·ªõi</button><div id="procSettings" class="space-y-2 py-4 border-b"></div><button onclick="addProcPrompt()" class="text-xs text-blue-600 font-bold mb-4 underline">+ Th√™m th·ªß thu·∫≠t m·ªõi</button><button onclick="closeModal('settingsModal')" class="w-full bg-emerald-800 text-white py-4 rounded-2xl mt-4 font-bold shadow-lg uppercase">Ho√†n t·∫•t</button></div></div>

    <script>
        // --- DATA & CONFIG ---
        const tuChan = {
            vong: ['L∆∞·ª°i b·ªáu', 'L∆∞·ª°i g·∫ßy', 'L∆∞·ª°i ƒë·ªè', 'L∆∞·ª°i t√≠m/·ª© huy·∫øt', 'R√™u tr·∫Øng m·ªèng', 'R√™u v√†ng d√†y', 'R√™u b·∫©n', 'S·∫Øc di·ªán nh·ª£t'],
            van: ['M√πi c∆° th·ªÉ', 'Gi·ªçng n√≥i kh√†n', 'T·∫Øt ti·∫øng', 'H∆°i th·ªü h√¥i', 'Ho c√≥ ƒë·ªùm'],
            vanHoi: ['Ng·ªß ƒë∆∞·ª£c', 'M·∫•t ng·ªß', 'Ti·ªÉu ƒë√™m', 'T√°o b√≥n', 'Ti√™u l·ªèng', 'Kh√≠ ƒëo·∫£n', 'Hay lo √¢u', 'ƒÇn k√©m'],
            thiet: ['C·ª± √°n (·∫§n ƒëau)', 'Thi·ªán √°n (Th√≠ch xoa)', 'M·∫°ch Ph√π', 'M·∫°ch Tr·∫ßm', 'M·∫°ch Ho·∫°t', 'M·∫°ch T·∫ø', 'H·ªØu l·ª±c', 'V√¥ l·ª±c']
        };

        let procedures = JSON.parse(localStorage.getItem('yhct_procs')) || [{ id: 1, name: 'Ch√¢m c·ª©u', price: 150000 }, { id: 2, name: 'Xoa b√≥p', price: 200000 }];
        let diseases = JSON.parse(localStorage.getItem('yhct_diseases')) || [
            { name: 'Tho√°i h√≥a c·ªôt s·ªëng', extra: ['Co c·ª©ng c∆°', 'L4-L5', 'L5-S1', 'T√™ b√¨ ch√¢n', 'ƒêau tƒÉng khi v·∫≠n ƒë·ªông'] },
            { name: 'ƒêau c·ªï vai g√°y', extra: ['Lan xu·ªëng tay', 'H·ªôi ch·ª©ng t·∫ßng C5-C6', 'Hoa m·∫Øt ch√≥ng m·∫∑t'] },
            { name: 'Li·ªát Bell (Li·ªát m·∫∑t)', extra: ['B√™n TR√ÅI', 'B√™n PH·∫¢I', 'M·∫Øt nh·∫Øm kh√¥ng k√≠n', 'M·∫•t n·∫øp nhƒÉn tr√°n'] }
        ];
        let patients = JSON.parse(localStorage.getItem('yhct_patients_v2')) || [];

        const openModal = (id) => document.getElementById(id).classList.add('active');
        const closeModal = (id) => document.getElementById(id).classList.remove('active');
        const saveData = () => {
            localStorage.setItem('yhct_patients_v2', JSON.stringify(patients));
            localStorage.setItem('yhct_procs', JSON.stringify(procedures));
            localStorage.setItem('yhct_diseases', JSON.stringify(diseases));
        };

        // --- PATIENT LOGIC (FIXED) ---
        function openPatientModal(pId = null) {
            document.getElementById('patientForm').reset();
            document.getElementById('editPatientId').value = pId || '';
            if(pId) {
                const p = patients.find(x => x.id == pId);
                document.getElementById('pName').value = p.name;
                document.getElementById('pYear').value = p.year;
                document.getElementById('pPhone').value = p.phone || '';
                document.getElementById('pAddress').value = p.address || '';
            }
            openModal('patientModal');
        }

        document.getElementById('patientForm').onsubmit = (e) => {
            e.preventDefault();
            const pId = document.getElementById('editPatientId').value;
            const pData = {
                id: pId || Date.now().toString(),
                name: document.getElementById('pName').value,
                year: document.getElementById('pYear').value,
                phone: document.getElementById('pPhone').value,
                address: document.getElementById('pAddress').value,
                visits: pId ? patients.find(x => x.id == pId).visits : []
            };

            if(pId) {
                const idx = patients.findIndex(x => x.id == pId);
                patients[idx] = pData;
            } else {
                patients.unshift(pData);
            }
            saveData(); renderPatients(); closeModal('patientModal');
        };

        // --- TAGS & VISIT LOGIC ---
        function renderTags(containerId, tags, targetInputId) {
            const container = document.getElementById(containerId); container.innerHTML = '';
            tags.forEach(tag => {
                const btn = document.createElement('button');
                btn.type = 'button'; btn.className = 'btn-tag'; btn.innerText = tag;
                btn.onclick = () => {
                    if (targetInputId === 'visitDisease') {
                        document.getElementById(targetInputId).value = tag;
                        document.querySelectorAll(`#${containerId} .btn-tag`).forEach(b => b.classList.remove('active'));
                        btn.classList.add('active'); showSpecificFields(tag);
                    } else { btn.classList.toggle('active'); }
                };
                container.appendChild(btn);
            });
        }

        function showSpecificFields(diseaseName) {
            const disease = diseases.find(d => d.name === diseaseName);
            const area = document.getElementById('specificArea');
            const container = document.getElementById('specificTags');
            if (disease && disease.extra) {
                area.classList.remove('hidden'); container.innerHTML = '';
                disease.extra.forEach(ex => {
                    const btn = document.createElement('button');
                    btn.type = 'button'; btn.className = 'btn-tag'; btn.innerText = ex;
                    btn.onclick = () => btn.classList.toggle('active');
                    container.appendChild(btn);
                });
            } else { area.classList.add('hidden'); }
        }

        function openVisitModal(pId, vId = null) {
            document.getElementById('visitForm').reset();
            document.getElementById('visitPatientId').value = pId;
            document.getElementById('editVisitId').value = vId || '';
            document.getElementById('specificArea').classList.add('hidden');
            
            renderTags('diseaseTags', diseases.map(d => d.name), 'visitDisease');
            renderTags('vongTags', tuChan.vong, '');
            renderTags('vanTags', tuChan.van, '');
            renderTags('vanHoiTags', tuChan.vanHoi, '');
            renderTags('thietTags', tuChan.thiet, '');
            
            const procContainer = document.getElementById('procChecklist');
            procContainer.innerHTML = procedures.map(proc => `
                <div class="proc-item" onclick="const c=this.querySelector('input');c.checked=!c.checked;calcTotal()">
                    <input type="checkbox" class="proc-check" value="${proc.id}" data-price="${proc.price}" onclick="event.stopPropagation();calcTotal()">
                    <label>${proc.name} (${proc.price.toLocaleString()}ƒë)</label>
                </div>
            `).join('');
            
            if(vId) {
                const p = patients.find(x => x.id == pId);
                const v = p.visits.find(x => x.id == vId);
                document.getElementById('visitDate').value = v.date;
                document.getElementById('visitDisease').value = v.disease;
                document.getElementById('medicinePrice').value = v.medPrice || 0;
                document.getElementById('medicineCost').value = v.cost || 0;
            } else {
                document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
            }
            calcTotal(); openModal('visitModal');
        }

        function calcTotal() {
            let t = 0;
            document.querySelectorAll('.proc-check:checked').forEach(c => t += parseInt(c.dataset.price));
            t += parseInt(document.getElementById('medicinePrice').value) || 0;
            document.getElementById('visitTotalLabel').innerText = t.toLocaleString() + 'ƒë';
            return t;
        }

        document.getElementById('visitForm').onsubmit = (e) => {
            e.preventDefault();
            const pId = document.getElementById('visitPatientId').value;
            const vId = document.getElementById('editVisitId').value;
            const getAct = (id) => Array.from(document.querySelectorAll(`#${id} .btn-tag.active`)).map(b => b.innerText);
            
            const vData = {
                id: vId ? parseInt(vId) : Date.now(),
                date: document.getElementById('visitDate').value,
                disease: document.getElementById('visitDisease').value,
                symptoms: ["V·ªçng:"+getAct('vongTags'), "VƒÉn:"+getAct('vanTags'), "H·ªèi:"+getAct('vanHoiTags'), "Thi·∫øt:"+getAct('thietTags'), "ƒê·∫∑c th√π:"+getAct('specificTags')].join(' | '),
                medicine: document.getElementById('visitMedicine').value,
                notes: document.getElementById('visitNotes').value,
                procs: Array.from(document.querySelectorAll('.proc-check:checked')).map(c => procedures.find(p => p.id == c.value).name).join(', '),
                medPrice: parseInt(document.getElementById('medicinePrice').value) || 0,
                cost: parseInt(document.getElementById('medicineCost').value) || 0,
                price: calcTotal(),
                isPaid: document.getElementById('visitPaid').checked
            };

            const pIdx = patients.findIndex(p => p.id == pId);
            if(vId) {
                const vIdx = patients[pIdx].visits.findIndex(v => v.id == vId);
                patients[pIdx].visits[vIdx] = vData;
            } else { patients[pIdx].visits.unshift(vData); }
            saveData(); renderPatients(); closeModal('visitModal');
        };

        // --- RENDERING ---
        function renderPatients() {
            const list = document.getElementById('patientList');
            const kw = document.getElementById('search').value.toLowerCase();
            let profit = 0; const curM = (new Date().getMonth()+1) + '/' + new Date().getFullYear();
            
            list.innerHTML = '';
            patients.forEach(p => {
                p.visits.forEach(v => { if(v.isPaid && (new Date(v.date).getMonth()+1 + '/' + new Date(v.date).getFullYear()) === curM) profit += (v.price - v.cost); });
                if(p.name.toLowerCase().includes(kw) || p.phone?.includes(kw)) {
                    const last = p.visits[0] || { disease: '-', date: '-' };
                    list.innerHTML += `<div class="card p-4 flex justify-between items-center border-l-8 border-emerald-700">
                        <div onclick="showHistory('${p.id}')" class="cursor-pointer">
                            <h3 class="font-bold text-emerald-900 uppercase">${p.name} <span class="text-gray-400 font-normal">(${p.phone || 'N/A'})</span></h3>
                            <p class="text-[11px] text-gray-500 mt-1">${last.date} | ${last.disease}</p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="openPatientModal('${p.id}')" class="bg-gray-100 text-gray-600 px-3 py-2 rounded-lg text-[10px] font-bold">S·ª¨A HS</button>
                             <button onclick="openVisitModal('${p.id}')" class="bg-emerald-700 text-white px-5 py-2 rounded-xl text-xs font-black">KH√ÅM</button>
                        </div>
                    </div>`;
                }
            });
            document.getElementById('totalProfit').innerText = profit.toLocaleString() + 'ƒë';
            document.getElementById('currentMonthLabel').innerText = "Th·ªëng k√™ th√°ng: " + curM;
        }

        function showHistory(pId) {
            const p = patients.find(x => x.id == pId);
            document.getElementById('histName').innerText = p.name;
            document.getElementById('histDetail').innerText = `Sinh nƒÉm: ${p.year} | SƒêT: ${p.phone || 'Ch∆∞a c√≥'} | ƒê·ªãa ch·ªâ: ${p.address || 'Ch∆∞a c√≥'}`;
            document.getElementById('histContent').innerHTML = p.visits.map(v => `
                <div class="p-4 border rounded-2xl bg-gray-50 text-xs">
                    <div class="flex justify-between font-black text-emerald-800 border-b pb-2 mb-2">
                        <span>${v.date} - ${v.disease}</span>
                        <span class="${v.isPaid ? 'text-emerald-700' : 'text-red-500'}">${v.price.toLocaleString()}ƒë</span>
                    </div>
                    <p><b>Tri·ªáu ch·ª©ng:</b> ${v.symptoms}</p>
                    <p><b>ƒê∆°n thu·ªëc:</b> ${v.medicine || '-'}</p>
                    <p><b>Th·ªß thu·∫≠t:</b> ${v.procs || '-'}</p>
                    <div class="mt-4 flex gap-4 no-print border-t pt-2">
                        <button onclick="openVisitModal('${p.id}', ${v.id})" class="text-blue-600 font-bold underline">S·ª¨A L·∫†I</button>
                        <button onclick="if(confirm('X√≥a?')){deleteVisit('${p.id}',${v.id})}" class="text-red-400 font-bold underline">XO√Å L∆Ø·ª¢T</button>
                    </div>
                </div>
            `).join('');
            openModal('historyModal');
        }

        function deleteVisit(pId, vId) {
            const p = patients.find(x => x.id == pId);
            p.visits = p.visits.filter(v => v.id != vId);
            saveData(); renderPatients(); showHistory(pId);
        }

        // --- SETTINGS ---
        function openSettingsModal() {
            const dCont = document.getElementById('diseaseSettings');
            dCont.innerHTML = diseases.map((d, i) => `<span class="bg-white border px-2 py-1 rounded-lg text-[11px]">${d.name} <button onclick="diseases.splice(${i},1);saveData();openSettingsModal()" class="text-red-500">√ó</button></span>`).join('');
            const pCont = document.getElementById('procSettings');
            pCont.innerHTML = procedures.map((p, i) => `<div class="flex gap-2"><input type="text" value="${p.name}" onchange="procedures[${i}].name=this.value;saveData()"><input type="number" value="${p.price}" onchange="procedures[${i}].price=this.value;saveData()" class="w-24"></div>`).join('');
            openModal('settingsModal');
        }
        function addDiseasePrompt() { const n = prompt("T√™n b·ªánh:"); if(n) { diseases.push({name:n, extra:[]}); saveData(); openSettingsModal(); } }
        function addProcPrompt() { procedures.push({id:Date.now(), name:'M·ªõi', price:0}); openSettingsModal(); }
        function exportCSV() {
            let csv = "\uFEFFNg√†y,T√™n,SƒêT,B·ªánh,T·ªïng Ti·ªÅn\n";
            patients.forEach(p => p.visits.forEach(v => { csv += `"${v.date}","${p.name}","${p.phone}","${v.disease}",${v.price}\n`; }));
            const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = "BaoCao.csv"; link.click();
        }

        renderPatients();
    </script>
</body>
</html>
