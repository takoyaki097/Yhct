<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YHCT Pro - Qu·∫£n l√Ω Chuy√™n s√¢u</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, system-ui, sans-serif; padding-bottom: 40px; }
        #mainHeader { position: relative; overflow: hidden; background-color: #064e3b; background-size: cover; background-position: center; border-radius: 0 0 40px 40px; min-height: 200px; display: flex; align-items: flex-end; }
        #headerOverlay { position: absolute; inset: 0; background: linear-gradient(rgba(0,0,0,0.1), rgba(0,0,0,0.8)); z-index: 1; }
        #headerContent { position: relative; z-index: 2; width: 100%; padding: 40px; }
        .swipe-container { position: relative; overflow: hidden; border-radius: 24px; margin-bottom: 12px; background: #be123c; }
        .patient-card { background: white; position: relative; z-index: 2; transition: 0.2s ease-out; touch-action: pan-y; }
        .delete-btn { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; display: flex; align-items: center; justify-content: center; color: white; z-index: 1; font-weight: bold; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 100; align-items: center; justify-content: center; padding: 15px; backdrop-filter: blur(12px); }
        .modal.active { display: flex; }
        input, textarea, select { border: 1px solid #e2e8f0; border-radius: 16px; padding: 14px; width: 100%; font-size: 16px; outline: none; transition: 0.2s; background: white; }
        input:focus { border-color: #059669; box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1); }
        .section-box { background: #f8fafc; border: 1px solid #f1f5f9; border-radius: 24px; padding: 20px; margin-bottom: 16px; }
        .label-mini { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 10px; display: block; letter-spacing: 0.8px; }
        .tag-btn { padding: 10px 16px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 14px; background: white; margin: 4px; display: inline-block; transition: 0.1s; color: #334155; cursor: pointer; }
        .tag-btn.active { background: #059669; color: white; border-color: #059669; font-weight: 600; }
        .discount-select { width: 70px; padding: 4px; border-radius: 8px; font-size: 12px; font-weight: bold; border: 1px solid #cbd5e1; background: #fff; }
    </style>
</head>
<body>

    <div class="max-w-3xl mx-auto">
        <div id="mainHeader" class="text-white shadow-2xl">
            <div id="headerOverlay"></div>
            <div id="headerContent" class="flex justify-between items-end">
                <div>
                    <h1 id="displayTitle" class="text-3xl font-black text-yellow-400 tracking-tighter uppercase">Ph√≤ng Kh√°m YHCT</h1>
                    <p id="displayDoctor" class="text-emerald-100 font-medium italic mt-1">Xin ch√†o B√°c sƒ©!</p>
                    <p id="monthLabel" class="text-[10px] opacity-70 font-bold uppercase mt-3 tracking-widest"></p>
                </div>
                <div class="text-right">
                    <p id="profitLabel" class="text-4xl font-black text-green-400">0ƒë</p>
                    <p class="text-[10px] uppercase opacity-60 font-black">L·ª£i nhu·∫≠n th·ª±c t·∫ø</p>
                </div>
            </div>
        </div>

        <div class="px-6 mt-8">
            <div class="grid grid-cols-4 gap-3 mb-8">
                <button onclick="openPatientModal()" class="col-span-2 bg-emerald-800 text-white py-5 rounded-3xl font-black shadow-lg uppercase text-sm active:scale-95">+ B·ªánh nh√¢n m·ªõi</button>
                <button onclick="exportExcel()" class="bg-white border-2 border-emerald-900 text-emerald-900 rounded-3xl font-black text-xs uppercase">Xu·∫•t B√°o C√°o</button>
                <button onclick="openSettings()" class="bg-slate-900 text-white rounded-3xl font-bold text-2xl">‚öôÔ∏è</button>
            </div>
            <input type="text" id="search" oninput="render()" placeholder="T√¨m t√™n ho·∫∑c SƒêT..." class="mb-6 shadow-md border-slate-200 py-5 px-6">
            <div id="list" class="space-y-1"></div>
        </div>
    </div>

    <div id="vModal" class="modal">
        <div class="bg-white w-full max-w-2xl p-8 rounded-[40px] shadow-2xl overflow-y-auto max-h-[96vh]">
            <div class="flex justify-between items-center border-b pb-5 mb-6">
                <h2 class="font-black text-2xl text-emerald-900 uppercase">Phi·∫øu Kh√°m Chuy√™n Khoa</h2>
                <button onclick="closeModals()" class="text-4xl text-slate-300">&times;</button>
            </div>
            
            <input type="hidden" id="vPid">
            <div class="space-y-6">
                <div class="section-box bg-blue-50/50 border-blue-100">
                    <span class="label-mini text-blue-700">‚ù§ Ch·ªâ s·ªë sinh t·ªìn</span>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 block mb-1 uppercase">Huy·∫øt √°p (mmHg)</label>
                            <div class="flex items-center bg-white border rounded-xl overflow-hidden h-[48px]">
                                <input type="number" id="vBpSys" value="120" class="border-none p-0 text-center font-bold w-full text-sm">
                                <span class="text-slate-300">/</span>
                                <input type="number" id="vBpDia" value="70" class="border-none p-0 text-center font-bold w-full text-sm">
                            </div>
                        </div>
                        <div><label class="text-[10px] font-bold text-slate-400 block mb-1 uppercase">M·∫°ch (L/p)</label><input type="number" id="vPulse" class="h-[48px] text-center font-bold text-sm"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 block mb-1 uppercase">BMI</label><input type="number" id="vBmi" step="0.1" class="h-[48px] text-center font-bold text-sm"></div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <div class="w-1/3"><span class="label-mini">Ng√†y kh√°m</span><input type="date" id="vDate"></div>
                    <div class="w-2/3"><span class="label-mini">Ch·∫©n ƒëo√°n (B·ªánh danh)</span><input list="diseaseOptions" id="vDiseaseInput" onchange="loadDiseasePresets()"></div>
                </div>

                <div class="section-box bg-yellow-50 border-yellow-100">
                    <span class="label-mini text-yellow-700">‚òÖ Di·ªÖn bi·∫øn & Tri·ªáu ch·ª©ng ƒë·∫∑c bi·ªát</span>
                    <div id="specialTagsBox" class="flex flex-wrap mb-4 hidden border-b border-yellow-100 pb-3"></div>
                    <textarea id="vSpecial" placeholder="Nh·∫≠p th√™m tri·ªáu ch·ª©ng ri√™ng bi·ªát..." rows="1" class="text-sm bg-white/70"></textarea>
                </div>

                <div class="space-y-3">
                    <span class="label-mini">T·ª© Ch·∫©n</span>
                    <div class="p-4 bg-slate-50 rounded-2xl"><span class="text-[10px] font-black text-emerald-800 block mb-2">1. V·ªåNG:</span><div id="boxVong" class="flex flex-wrap"></div><input type="text" id="vVongExtra" class="text-xs mt-2 bg-transparent border-dashed border-b" placeholder="..."></div>
                    <div class="p-4 bg-slate-50 rounded-2xl"><span class="text-[10px] font-black text-emerald-800 block mb-2">2. VƒÇN:</span><div id="boxVan" class="flex flex-wrap"></div><input type="text" id="vVanExtra" class="text-xs mt-2 bg-transparent border-dashed border-b" placeholder="..."></div>
                    <div class="p-4 bg-slate-50 rounded-2xl"><span class="text-[10px] font-black text-emerald-800 block mb-2">3. V·∫§N:</span><div id="boxVanHoi" class="flex flex-wrap"></div><input type="text" id="vVanHoiExtra" class="text-xs mt-2 bg-transparent border-dashed border-b" placeholder="..."></div>
                    <div class="p-4 bg-slate-50 rounded-2xl"><span class="text-[10px] font-black text-emerald-800 block mb-2">4. THI·∫æT:</span><div id="boxThiet" class="flex flex-wrap"></div><input type="text" id="vThietExtra" class="text-xs mt-2 bg-transparent border-dashed border-b" placeholder="..."></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="section-box m-0"><span class="label-mini">Th·ªß thu·∫≠t & Gi·∫£m gi√°</span><div id="vProcs" class="space-y-2 max-h-60 overflow-y-auto"></div></div>
                    <div class="section-box m-0"><span class="label-mini">ƒê∆°n thu·ªëc</span><textarea id="vMed" class="h-full min-h-[120px] text-sm"></textarea></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><span class="label-mini">Ph√≠ thu (G·ªëc)</span><input type="number" id="vPrice" oninput="calcV()" class="font-bold text-emerald-700" placeholder="0"></div>
                    <div><span class="label-mini text-rose-500">Gi√° v·ªën</span><input type="number" id="vCost" class="font-bold text-rose-700" placeholder="0"></div>
                </div>

                <div class="bg-emerald-900 text-white p-6 rounded-[30px] flex justify-between items-center shadow-xl">
                    <div><span class="label-mini text-emerald-300">T·ªïng th·ª±c thu (ƒê√£ tr·ª´ gi·∫£m gi√°)</span><p class="text-4xl font-black text-yellow-400" id="vTotal">0ƒë</p></div>
                    <label class="flex items-center gap-2 font-bold"><input type="checkbox" id="vPaid" checked class="w-6 h-6"> ƒê√É THU</label>
                </div>

                <button onclick="saveVisit()" class="w-full py-6 bg-emerald-700 text-white rounded-3xl font-black uppercase text-xl shadow-lg">L∆∞u b·ªánh √°n</button>
            </div>
        </div>
    </div>

    <div id="sModal" class="modal">
        <div class="bg-white w-full max-w-2xl p-10 rounded-[45px] shadow-2xl overflow-y-auto max-h-[92vh]">
            <h2 class="font-black text-2xl text-center uppercase mb-8 pb-4 border-b">C·∫•u h√¨nh H·ªá th·ªëng</h2>
            <div class="space-y-10">
                <section class="bg-emerald-50 p-6 rounded-[30px] border border-emerald-100">
                    <span class="label-mini text-emerald-800">1. Th√¥ng tin Ph√≤ng kh√°m & B√°c sƒ©</span>
                    <div class="space-y-4">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">T√™n ti√™u ƒë·ªÅ hi·ªÉn th·ªã</label><input type="text" id="editClinicTitle" class="mt-1 shadow-sm"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">T√™n b√°c sƒ©</label><input type="text" id="editDoctorName" class="mt-1 shadow-sm"></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">H√¨nh n·ªÅn ti√™u ƒë·ªÅ</label><input type="file" id="bgInput" onchange="updateHeaderBg()" class="mt-1 text-xs"></div>
                    </div>
                </section>
                <section><span class="label-mini">2. N√∫t nhanh T·ª© ch·∫©n</span><div class="grid grid-cols-2 gap-4 mt-3 text-xs uppercase font-bold"><div>V·ªçng:<textarea id="editVong" class="h-20 text-xs mt-1 font-normal"></textarea></div><div>VƒÉn:<textarea id="editVan" class="h-20 text-xs mt-1 font-normal"></textarea></div><div>V·∫•n:<textarea id="editVanHoi" class="h-20 text-xs mt-1 font-normal"></textarea></div><div>Thi·∫øt:<textarea id="editThiet" class="h-20 text-xs mt-1 font-normal"></textarea></div></div></section>
                <section><span class="label-mini">3. Th∆∞ vi·ªán B·ªánh danh</span><div id="setDiseases" class="space-y-2 mb-4"></div><div class="bg-slate-50 p-6 rounded-3xl space-y-3 border"><input type="text" id="newDisName" placeholder="T√™n b·ªánh..." class="text-sm"><textarea id="newDisSym" placeholder="Tri·ªáu ch·ª©ng ƒë·∫∑c bi·ªát..." class="text-sm"></textarea><button onclick="addItem('diseases')" class="w-full bg-emerald-700 text-white py-4 rounded-2xl font-black text-xs uppercase">Th√™m B·ªánh</button></div></section>
                <section><span class="label-mini">4. Th·ªß thu·∫≠t & Gi√° m·∫∑c ƒë·ªãnh</span><div id="setProcs" class="space-y-2 mb-4"></div><div class="flex gap-3"><input type="text" id="newProcName" placeholder="T√™n..." class="text-sm"><input type="number" id="newProcPrice" placeholder="Gi√°..." class="text-sm w-32"><button onclick="addItem('procs')" class="bg-emerald-600 text-white px-8 rounded-2xl font-bold">+</button></div></section>
            </div>
            <div class="flex gap-4 mt-12"><button onclick="saveAllConfigs()" class="flex-grow py-5 bg-emerald-800 text-white rounded-3xl font-black uppercase">L∆∞u c√†i ƒë·∫∑t</button><button onclick="closeModals()" class="px-10 py-5 bg-slate-100 rounded-3xl font-bold text-slate-400">ƒê√≥ng</button></div>
        </div>
    </div>

    <div id="pModal" class="modal"><div class="bg-white w-full max-w-md p-10 rounded-[40px] shadow-2xl"><h2 class="font-black mb-6 uppercase text-center text-emerald-900">Th√¥ng tin b·ªánh nh√¢n</h2><input type="hidden" id="editId"><input type="text" id="pName" placeholder="H·ªç v√† t√™n *"><div class="flex gap-3 my-4"><input type="number" id="pYear" placeholder="NƒÉm sinh"><input type="tel" id="pPhone" placeholder="SƒêT"></div><input type="text" id="pAddress" placeholder="ƒê·ªãa ch·ªâ"><div class="flex gap-3 mt-8"><button onclick="closeModals()" class="flex-1 py-5 text-slate-400 font-bold uppercase">H·ªßy</button><button onclick="savePatient()" class="flex-1 py-5 bg-emerald-800 text-white rounded-3xl font-black uppercase shadow-lg">L∆∞u h·ªì s∆°</button></div></div></div>
    
    <div id="hModal" class="modal"><div class="bg-white w-full max-w-2xl p-10 rounded-[40px] overflow-y-auto max-h-[92vh]"><div class="flex justify-between items-center mb-8 border-b pb-4"><h2 id="hName" class="font-black text-2xl uppercase text-emerald-900"></h2><button onclick="closeModals()" class="text-4xl text-slate-300">&times;</button></div><div id="hContent" class="space-y-8"></div></div></div>

    <datalist id="diseaseOptions"></datalist>

    <script>
        const defaultTC = { vong: ['Th·∫ßn t·ªânh', 'S·∫Øc t∆∞∆°i'], van: ['Ti·∫øng vang'], vanHoi: ['ƒÇn ƒë∆∞·ª£c'], thiet: ['M·∫°ch Ho·∫°t'] };
        let db = JSON.parse(localStorage.getItem('yhct_db_v7') || '[]');
        let config = JSON.parse(localStorage.getItem('yhct_cfg_v7')) || { 
            headerBg: '', clinicTitle: 'Ph√≤ng Kh√°m YHCT', doctorName: '',
            procs: [{name: 'Ch√¢m c·ª©u', price: 100000}], diseases: [], tuChan: defaultTC 
        };

        function saveConfig() { 
            localStorage.setItem('yhct_cfg_v7', JSON.stringify(config)); 
            renderSettings(); applyDiseaseOptions(); updateHeaderUI();
        }

        function updateHeaderUI() {
            document.getElementById('displayTitle').innerText = config.clinicTitle || 'Ph√≤ng Kh√°m YHCT';
            document.getElementById('displayDoctor').innerText = config.doctorName ? `Xin ch√†o B√°c sƒ© ${config.doctorName}!` : 'Xin ch√†o B√°c sƒ©!';
            if(config.headerBg) document.getElementById('mainHeader').style.backgroundImage = `url(${config.headerBg})`;
        }

        function render() {
            const list = document.getElementById('list'); const kw = document.getElementById('search').value.toLowerCase();
            let totalProfit = 0; let curMY = (new Date().getMonth() + 1) + '/' + new Date().getFullYear();
            list.innerHTML = '';
            db.forEach(p => {
                p.visits.forEach(v => { if(v.paid && (new Date(v.date).getMonth()+1 + '/' + new Date(v.date).getFullYear() == curMY)) totalProfit += (v.price - v.cost); });
                if(p.name.toLowerCase().includes(kw) || (p.phone && p.phone.includes(kw))) {
                    list.innerHTML += `<div class="swipe-container shadow-sm"><div class="delete-btn" onclick="confirmDelete('${p.id}')">X√ìA</div>
                        <div id="card-${p.id}" class="patient-card p-6 flex justify-between items-center" ontouchstart="sX=event.touches[0].clientX" ontouchmove="if(sX-event.touches[0].clientX>70)this.style.transform='translateX(-80px)';else if(sX-event.touches[0].clientX<-30)this.style.transform='translateX(0)'">
                            <div onclick="showHistory('${p.id}')" class="flex-grow cursor-pointer"><h3 class="font-black text-xl uppercase">${p.name}</h3><p class="text-xs font-bold text-slate-400 mt-1 uppercase">${p.phone || 'N/A'} ‚Ä¢ SN ${p.year || 'N/A'}</p></div>
                            <div class="flex gap-2"><button onclick="openPatientModal('${p.id}')" class="p-5 bg-slate-50 rounded-3xl text-slate-400">‚úé</button><button onclick="openVisitModal('${p.id}')" class="bg-emerald-800 text-white px-8 py-5 rounded-3xl font-black text-xs uppercase shadow-lg">Kh√°m</button></div>
                        </div></div>`;
                }
            });
            document.getElementById('profitLabel').innerText = totalProfit.toLocaleString() + 'ƒë';
            document.getElementById('monthLabel').innerText = 'D·ªØ li·ªáu th√°ng ' + curMY;
        }

        function openVisitModal(pid) {
            document.getElementById('vPid').value = pid; document.getElementById('vDate').value = new Date().toISOString().split('T')[0];
            document.querySelectorAll('#vModal input:not(#vPid):not(#vDate), #vModal textarea').forEach(i=>i.value='');
            document.getElementById('vBpSys').value="120"; document.getElementById('vBpDia').value="70";
            const rt = (id, l) => document.getElementById(id).innerHTML = l.map(t=>`<button class="tag-btn" onclick="this.classList.toggle('active')">${t}</button>`).join('');
            rt('boxVong', config.tuChan.vong); rt('boxVan', config.tuChan.van); rt('boxVanHoi', config.tuChan.vanHoi); rt('boxThiet', config.tuChan.thiet);
            
            // Render th·ªß thu·∫≠t c√≥ gi√° v√† √¥ % gi·∫£m gi√°
            document.getElementById('vProcs').innerHTML = config.procs.map(p=>`
                <div class="flex items-center justify-between p-3 bg-white border rounded-xl shadow-sm">
                    <div class="flex items-center gap-2 flex-grow cursor-pointer" onclick="toggleVProc(this)">
                        <input type="checkbox" class="v-proc-check w-5 h-5" data-price="${p.price}" value="${p.name}" onclick="event.stopPropagation();calcV()">
                        <div>
                            <p class="text-[10px] font-black uppercase leading-tight">${p.name}</p>
                            <p class="text-[9px] text-emerald-600 font-bold">${p.price.toLocaleString()}ƒë</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-[8px] font-bold text-slate-400 uppercase">Gi·∫£m:</span>
                        <select class="discount-select" onchange="calcV()">
                            <option value="0">0%</option><option value="5">5%</option><option value="10">10%</option>
                            <option value="15">15%</option><option value="20">20%</option><option value="30">30%</option>
                            <option value="50">50%</option><option value="100">100%</option>
                        </select>
                    </div>
                </div>`).join('');
            document.getElementById('specialTagsBox').classList.add('hidden'); calcV(); document.getElementById('vModal').classList.add('active');
        }

        function calcV() {
            let total = parseInt(document.getElementById('vPrice').value) || 0;
            document.querySelectorAll('#vProcs > div').forEach(div => {
                const cb = div.querySelector('.v-proc-check');
                if (cb.checked) {
                    const price = parseInt(cb.dataset.price);
                    const discount = parseInt(div.querySelector('.discount-select').value);
                    total += price * (1 - discount / 100);
                }
            });
            document.getElementById('vTotal').innerText = Math.round(total).toLocaleString() + 'ƒë';
        }

        function toggleVProc(divChild) { 
            const parent = divChild.parentElement;
            const cb = parent.querySelector('.v-proc-check');
            cb.checked = !cb.checked; 
            calcV(); 
        }

        function saveVisit() {
            const pid = document.getElementById('vPid').value; const i = db.findIndex(x=>x.id==pid);
            const getT = (b, e) => [Array.from(document.querySelectorAll(`#${b} .tag-btn.active`)).map(x=>x.innerText).join(', '), document.getElementById(e).value].filter(x=>x).join('; ');
            
            let finalPrice = parseInt(document.getElementById('vPrice').value) || 0;
            let procDetails = [];
            document.querySelectorAll('#vProcs > div').forEach(div => {
                const cb = div.querySelector('.v-proc-check');
                if (cb.checked) {
                    const p = parseInt(cb.dataset.price);
                    const d = parseInt(div.querySelector('.discount-select').value);
                    const net = p * (1 - d / 100);
                    finalPrice += net;
                    procDetails.push(`${cb.value} (${d>0?'-'+d+'%':''})`);
                }
            });

            const v = { id:Date.now(), date:document.getElementById('vDate').value, bp:document.getElementById('vBpSys').value+'/'+document.getElementById('vBpDia').value, pulse:document.getElementById('vPulse').value, bmi:document.getElementById('vBmi').value, disease:document.getElementById('vDiseaseInput').value, special:document.getElementById('vSpecial').value, vong:getT('boxVong','vVongExtra'), van:getT('boxVan','vVanExtra'), vanHoi:getT('boxVanHoi','vVanHoiExtra'), thiet:getT('boxThiet','vThietExtra'), procs:procDetails.join(', '), med:document.getElementById('vMed').value, price:Math.round(finalPrice), cost:parseInt(document.getElementById('vCost').value)||0, paid:document.getElementById('vPaid').checked };
            db[i].visits.unshift(v); localStorage.setItem('yhct_db_v7', JSON.stringify(db)); render(); closeModals();
        }

        function showHistory(pid) {
            const p = db.find(x=>x.id==pid); document.getElementById('hName').innerText = p.name;
            document.getElementById('hContent').innerHTML = p.visits.map(v => `<div class="p-6 bg-slate-50 rounded-[35px] border relative shadow-sm"><div class="flex justify-between text-[10px] font-black uppercase text-emerald-800 mb-4"><span>üìÖ ${v.date}</span><span class="bg-white px-3 py-1 rounded-full">L√£i: ${(v.price-v.cost).toLocaleString()}ƒë</span></div><div class="flex gap-3 mb-4 text-[10px] font-bold text-blue-600 bg-blue-100/50 p-2 rounded-xl"><span>HA: ${v.bp||'120/70'}</span><span>M·∫°ch: ${v.pulse||'-'}</span><span>BMI: ${v.bmi||'-'}</span></div><p class="font-black text-xl uppercase text-slate-900 border-b pb-2 mb-3">${v.disease||'Ch∆∞a b·ªánh danh'}</p><div class="text-[12px] space-y-2 text-slate-600 italic"><p><b>Th·ªß thu·∫≠t:</b> ${v.procs||'-'}</p><p><b>V·ªçng:</b> ${v.vong||'-'}</p><p><b>VƒÉn:</b> ${v.van||'-'}</p><p><b>V·∫•n:</b> ${v.vanHoi||'-'}</p><p><b>Thi·∫øt:</b> ${v.thiet||'-'}</p></div><div class="mt-4 bg-emerald-900 text-white p-4 rounded-2xl text-sm">üíä ${v.med || '-'}</div></div>`).join('') || 'Ch∆∞a c√≥ d·ªØ li·ªáu';
            document.getElementById('hModal').classList.add('active');
        }

        function exportExcel() {
            const now = new Date(); const curMonthYear = (now.getMonth() + 1) + '/' + now.getFullYear();
            let excelTemplate = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><style>.title { font-size: 18px; font-weight: bold; color: #064e3b; text-align: center; height: 50px; } table { border-collapse: collapse; width: 100%; } th { background-color: #059669; color: #ffffff; border: 1px solid #064e3b; padding: 10px; text-transform: uppercase; font-size: 12px; } td { border: 1px solid #cbd5e1; padding: 8px; font-size: 11px; vertical-align: middle; } .money { text-align: right; font-weight: bold; color: #b91c1c; }</style></head><body><table><tr><td colspan="15" class="title">TH·ªêNG K√ä PH√íNG KH√ÅM TH√ÅNG ${curMonthYear}</td></tr><tr><th>Ng√†y</th><th>B·ªánh Nh√¢n</th><th>B·ªánh danh</th><th>Th·ªß thu·∫≠t</th><th>Th·ª±c thu</th><th>L·ª£i nhu·∫≠n</th></tr>`;
            db.forEach(p => { p.visits.forEach(v => { excelTemplate += `<tr><td>${v.date}</td><td>${p.name}</td><td>${v.disease}</td><td>${v.procs}</td><td class="money">${v.price.toLocaleString()}</td><td class="money">${(v.price - v.cost).toLocaleString()}</td></tr>`; }); });
            excelTemplate += `</table></body></html>`;
            const blob = new Blob([excelTemplate], { type: 'application/vnd.ms-excel' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `BaoCao_YHCT.xls`; link.click();
        }

        function loadDiseasePresets() {
            const val = document.getElementById('vDiseaseInput').value; const dis = config.diseases.find(d=>d.name===val);
            if(dis && dis.sym) {
                document.getElementById('specialTagsBox').innerHTML = dis.sym.split(',').map(s=>`<button class="tag-btn" style="border-color:#fde047" onclick="document.getElementById('vSpecial').value+=(document.getElementById('vSpecial').value?', ':'')+this.innerText.trim()">${s.trim()}</button>`).join('');
                document.getElementById('specialTagsBox').classList.remove('hidden');
            } else document.getElementById('specialTagsBox').classList.add('hidden');
        }

        function openSettings() {
            document.getElementById('editClinicTitle').value = config.clinicTitle || '';
            document.getElementById('editDoctorName').value = config.doctorName || '';
            document.getElementById('editVong').value = config.tuChan.vong.join(', ');
            document.getElementById('editVan').value = config.tuChan.van.join(', ');
            document.getElementById('editVanHoi').value = config.tuChan.vanHoi.join(', ');
            document.getElementById('editThiet').value = config.tuChan.thiet.join(', ');
            renderSettings(); document.getElementById('sModal').classList.add('active');
        }

        function renderSettings() {
            document.getElementById('setDiseases').innerHTML = config.diseases.map((d, i) => `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border text-xs font-bold"><span>${d.name}</span><button onclick="removeItem('diseases', ${i})" class="text-red-500">X√≥a</button></div>`).join('');
            document.getElementById('setProcs').innerHTML = config.procs.map((p, i) => `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border text-xs font-bold"><span>${p.name} (${p.price.toLocaleString()}ƒë)</span><button onclick="removeItem('procs', ${i})" class="text-red-500">X√≥a</button></div>`).join('');
        }

        function saveAllConfigs() {
            config.clinicTitle = document.getElementById('editClinicTitle').value.trim();
            config.doctorName = document.getElementById('editDoctorName').value.trim();
            config.tuChan.vong = document.getElementById('editVong').value.split(',').map(s=>s.trim()).filter(s=>s);
            config.tuChan.van = document.getElementById('editVan').value.split(',').map(s=>s.trim()).filter(s=>s);
            config.tuChan.vanHoi = document.getElementById('editVanHoi').value.split(',').map(s=>s.trim()).filter(s=>s);
            config.tuChan.thiet = document.getElementById('editThiet').value.split(',').map(s=>s.trim()).filter(s=>s);
            saveConfig(); closeModals();
        }

        function addItem(t) {
            if(t==='procs') { const n=document.getElementById('newProcName').value, p=parseInt(document.getElementById('newProcPrice').value)||0; if(n) config.procs.push({name:n, price:p}); }
            else { const n=document.getElementById('newDisName').value, s=document.getElementById('newDisSym').value; if(n) config.diseases.push({name:n, sym:s}); }
            saveConfig();
        }
        function removeItem(t, i) { config[t].splice(i,1); saveConfig(); }
        function updateHeaderBg() { const f=document.getElementById('bgInput').files[0], r=new FileReader(); r.onloadend=()=>{config.headerBg=r.result; saveConfig();}; if(f) r.readAsDataURL(f); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active')); }
        function applyDiseaseOptions() { document.getElementById('diseaseOptions').innerHTML = config.diseases.map(d=>`<option value="${d.name}">`).join(''); }
        function openPatientModal(id=null) { document.getElementById('editId').value=id||''; if(id){ let p=db.find(x=>x.id==id); document.getElementById('pName').value=p.name; document.getElementById('pYear').value=p.year; document.getElementById('pPhone').value=p.phone; document.getElementById('pAddress').value=p.address; } else document.querySelectorAll('#pModal input').forEach(i=>i.value=''); document.getElementById('pModal').classList.add('active'); }
        function savePatient() { let id=document.getElementById('editId').value, name=document.getElementById('pName').value; if(!name) return; let p={id:id||Date.now().toString(), name, year:document.getElementById('pYear').value, phone:document.getElementById('pPhone').value, address:document.getElementById('pAddress').value, visits:id?db.find(x=>x.id==id).visits:[]}; if(id) db[db.findIndex(x=>x.id==id)]=p; else db.unshift(p); localStorage.setItem('yhct_db_v7', JSON.stringify(db)); render(); closeModals(); }
        function confirmDelete(id) { if(confirm('X√≥a?')) { db=db.filter(x=>x.id!=id); localStorage.setItem('yhct_db_v7', JSON.stringify(db)); render(); } }

        updateHeaderUI(); applyDiseaseOptions(); render();
    </script>
</body>
</html>
